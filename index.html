<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Chemin Vers Le Coran</title>
    
    <!-- ÉTAPE 3.1 : Lier le fichier Manifest -->
    <link rel="manifest" href="manifest.json">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="translations.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');

        :root {
            --primary-color: #2E7D32; --primary-light: #A5D6A7;
            --background-color-light: #F5F7FA; --text-color-light: #121212;
            --card-bg-light: #FFFFFF; --border-color-light: #E0E0E0;
            --background-color-dark: #121212; --text-color-dark: #E0E0E0;
            --card-bg-dark: #1E1E1E; --border-color-dark: #333333;
            --success-color: #4CAF50; --warning-color: #FFC107; --danger-color: #F44336;
            --bg: var(--background-color-light); --text: var(--text-color-light);
            --card-bg: var(--card-bg-light); --border-color: var(--border-color-light);
        }
        .dark-mode { --bg: var(--background-color-dark); --text: var(--text-color-dark); --card-bg: var(--card-bg-dark); --border-color: var(--border-color-dark); }
        .sepia-mode { --bg: #f4ecd8; --text: #4b392d; --card-bg: #fefaf1; --border-color: #e0d7c6; }
        .chalkboard-mode { --bg: #2b2b2b; --text: #f1f1f1; --card-bg: #333; --border-color: #444; }
        .wood-mode { --bg: #e0c9a6; --text: #2b1a0d; --card-bg: #f5e6cc; --border-color: #c2a87e; }
        .nightblue-mode { --bg: #0d1b2a; --text: #ffffff; --card-bg: #1b263b; --border-color: #415a77; }
        .sand-mode { --bg: #fff6e1; --text: #3e3119; --card-bg: #fdf1cf; --border-color: #e4d4ab; }
        .emerald-mode { --bg: #e8f5e9; --text: #1b5e20; --card-bg: #d0f0d8; --border-color: #a5d6a7; }
        .sunrise-mode { --bg: #fff6e1; --text: #442b1c; --card-bg: #ffecc2; --border-color: #d4a373; }
        .leafy-mode { --bg: #e9fbe5; --text: #264d00; --card-bg: #d6f7c9; --border-color: #a0cfa0; }
        .pearl-mode { --bg: #fdfdfd; --text: #2e2e2e; --card-bg: #f8f8f8; --border-color: #cccccc; }
        .midnight-mode { --bg: #0a0c10; --text: #e0e0e0; --card-bg: #1c1f24; --border-color: #2e3338; }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { font-family: 'Cairo', sans-serif; background-color: var(--bg); color: var(--text); transition: background-color 0.3s, color 0.3s; line-height: 1.6; font-weight: 500; }
        [dir="rtl"] { text-align: right; }
        
        #language-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            padding: 20px;
        }
        .language-card {
            background-color: white;
            padding: 40px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 90%;
            font-family: 'Cairo', sans-serif;
        }
        .language-card h2 {
            font-size: 1.8em;
            margin-bottom: 25px;
            color: #333;
        }
        .lang-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 300px;
        }
        .lang-options button {
            font-size: 1.2em;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s;
        }
        .lang-options button:hover {
            background-color: #256a29;
            transform: translateY(-2px);
        }

        #splash-screen { position: fixed; inset: 0; background: linear-gradient(120deg, #f9f9f9, #e0eafc); display: none; align-items: center; justify-content: center; z-index: 10000; animation: fadeOut 1s ease-out 4s forwards; }
        .logo-container { text-align: center; font-family: 'Cairo', sans-serif; }
        .logo-img { width: 300px; height: 300px; object-fit: contain; animation: logoPop 2s ease; margin-bottom: 10px; }
        .fade-in { opacity: 0; animation: fadeIn 1.5s ease-in forwards; }
        .fade-in.delay { animation-delay: 0.8s; }
        .fade-in.delay-2 { animation-delay: 1.2s; }
        @keyframes logoPop { 0% { transform: scale(0.2); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

        .welcome-page { position: fixed; inset: 0; background: linear-gradient(135deg, #f0f2f5, #e6e9f0); z-index: 9998; display: none; align-items: center; justify-content: center; }
        .welcome-overlay { background-color: rgba(255, 255, 255, 0.95); padding: 40px 20px; border-radius: 12px; text-align: center; max-width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .welcome-title { font-size: 2.5em; margin-bottom: 10px; color: #222; font-family: 'Amiri', serif; }
        .welcome-text { font-size: 1.2em; margin-bottom: 30px; color: #444; }
        .welcome-buttons { display: flex; flex-direction: column; gap: 15px; }
        .welcome-btn { padding: 12px 25px; color: white; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; font-size: 1.1em;}
        #create-profile-btn { background-color: #2E7D32; }
        #login-btn { background-color: #c19a6b; }

        #app-container { width: 100%; max-width: none; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--card-bg); padding: 30px; border-radius: 12px; width: 90%; max-width: 550px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 95vh; display: flex; flex-direction: column; position:relative;}
        .modal-content h2, .modal-content h3 { color: var(--primary-color); margin-bottom: 20px; }
        
        #login-screen .modal-content, #program-type-screen .modal-content { text-align: center; }
        #program-type-buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        #login-screen .form-group { margin-bottom: 15px; }
        #login-screen input { width: 100%; padding: 12px; }
        #login-screen .login-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; width: 100%;}
        .btn-back-welcome { background-color: var(--border-color); color: var(--text); padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-family: 'Cairo', sans-serif; font-size: 1em; transition: all 0.2s ease; margin-top: 20px; }

        .wizard-step-card { padding: 10px; flex-grow: 1; overflow-y: auto; scroll-behavior: smooth; }
        .wizard-step-card h3 { font-size: 1.5rem; margin-bottom: 25px; }
        .wizard-nav { display: flex; justify-content: space-between; margin-top: 30px; flex-shrink: 0; }
        .choice-btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .choice-btn { padding: 15px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; text-align: center; font-weight: 600; }
        .choice-btn .icon { font-size: 1.8rem; display: block; margin-bottom: 5px; }
        .choice-btn p { font-size: 0.9em; margin-top: 8px; color: var(--text); opacity: 0.8; }
        .choice-btn.selected { border-color: var(--primary-color); background-color: var(--primary-light); color: #121212; transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-family: 'Cairo', sans-serif; font-size: 1em; transition: all 0.2s ease; }
        .btn-sm { padding: 8px 16px; font-size: 0.9rem; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-secondary { background-color: var(--border-color); color: var(--text); }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: #121212; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .forgot-password { margin-top: 15px; font-size: 0.9rem; color: var(--primary-light); cursor: pointer; }

        .form-group { margin-bottom: 20px; text-align: left; }
        [dir="rtl"] .form-group { text-align: right; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input[type="text"], .form-group input[type="password"], .form-group select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg); color: var(--text); font-size: 1rem; }
        
        .styled-input { padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg); color: var(--text); width: 100%; font-size: 1em; transition: border-color 0.2s; }
        .styled-input:focus { border-color: var(--primary-color); outline: none; }
        
        .gender-options { display: flex; gap: 20px; margin-top: 8px; }
        .gender-choice { display: flex; align-items: center; gap: 8px; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg); cursor: pointer; transition: background 0.2s, border-color 0.2s; flex-grow: 1; justify-content: center; }
        .gender-choice:hover { background: var(--border-color); }
        .gender-choice input[type="radio"] { display: none; }
        .gender-choice input[type="radio"]:checked + span { color: var(--primary-color); font-weight: 700; }
        .gender-choice input[type="radio"]:checked + span::before { content: '✓ '; }

        .grid-selection { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; max-height: 250px; overflow-y: auto; padding: 5px; }
        .grid-selection .grid-item { padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .grid-selection .grid-item.selected { border-color: var(--primary-color); background-color: var(--primary-light); color: #121212; }
        
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; position: relative; gap: 20px; }
        .header-greeting { font-family: 'Amiri', serif; font-size: 2.2em; line-height: 1.2; color: var(--primary-color); text-align: center; flex-grow: 1; flex-shrink: 0; }
        [dir="rtl"] .header-greeting { text-align: center; }
        .header-center { display: flex; align-items: center; gap: 20px; justify-content: center; }
        .app-logo { width: 120px; height: 120px; object-fit: contain; }
        .app-header h1 { font-size: 1.8rem; margin: 0; font-weight: 700; }
        
        #profile-section { position: absolute; top: 10px; right: 10px; }
        [dir="rtl"] #profile-section { right: auto; left: 10px; }
        #profile-initial { width: 45px; height: 45px; border-radius: 50%; background-color: var(--primary-color); color: #fff; font-weight: bold; text-align: center; line-height: 45px; cursor: pointer; font-size: 1.2em; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #profile-dropdown { position: absolute; top: 55px; right: 0; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 8px; z-index: 1000; width: 200px; }
        [dir="rtl"] #profile-dropdown { right: auto; left: 0; }
        #profile-dropdown button { background: none; border: none; text-align: left; color: var(--text); font-size: 0.95em; padding: 8px 12px; cursor: pointer; border-radius: 6px; transition: background-color 0.2s; }
        [dir="rtl"] #profile-dropdown button { text-align: right; }
        #profile-dropdown button:hover { background-color: var(--border-color); }
        
        nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .nav-tab { padding: 10px 20px; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s ease; }
        .nav-tab.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); transform: translateY(-2px); }
        .view-content { display: grid; gap: 25px; max-width: 1200px; margin: 0 auto; }

        .card { background-color: var(--card-bg); border-radius: 12px; padding: 25px; border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: all 0.3s ease; }
        .card-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .card-header .icon { font-size: 1.8rem; color: var(--primary-color); }
        .card-header h3 { margin: 0; font-size: 1.4rem; }
        #dashboard-view { grid-template-columns: 1fr; }
        #dashboard-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; }
        
        .progress-card-combined { display: flex; flex-direction: column; gap: 25px; }
        .progress-circles-container { display: flex; justify-content: center; align-items: center; gap: 30px; flex-wrap: wrap; }
        .progress-circle { position: relative; width: 120px; height: 120px; flex-shrink: 0; }
        .progress-circle svg { width: 120px; height: 120px; transform: rotate(-90deg); }
        .progress-circle circle { fill: none; stroke-width: 10; }
        .progress-circle .bg-circle { stroke: var(--border-color); }
        .progress-circle .progress-fg { stroke-dasharray: 314; stroke-dashoffset: 314; transition: stroke-dashoffset 1s ease-out; stroke-linecap: round; }
        #progress-fg-reading-circle { stroke: var(--primary-color); }
        #progress-fg-revision-circle { stroke: var(--success-color); }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; font-weight: 700; }
        .progress-text span { display: block; }
        .progress-percent { font-size: 1.8rem; }
        .progress-label { font-size: 0.8rem; color: #888; }
        
        .stats-grid-combined { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; width: 100%; border-top: 1px solid var(--border-color); padding-top: 20px; margin-top: 10px; }
        .stat-item { background: var(--bg); padding: 15px; border-radius: 8px; text-align: center; }
        .stat-item .value { font-size: 1.5rem; font-weight: 700; }
        .stat-item .label { font-size: 0.8rem; color: #888; }
        
        .action-card p { margin-bottom: 15px; font-size: 1.1rem; }
        .action-card .details { background-color: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 600; border-left: 4px solid var(--primary-color); }
        .action-card .details p { margin: 5px 0; font-size: 1rem; }
        .action-card .next-revision-details { margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border-color); font-size: 0.9em; opacity: 0.8; }
        [dir="rtl"] .action-card .details { border-left: none; border-right: 4px solid var(--primary-color); }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        
        .plan-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .plan-day { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; background: var(--card-bg); }
        .plan-day-header { font-weight: bold; color: var(--primary-color); margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);}
        .plan-day-header .date-string { font-size: 0.8em; color: #888; display: block; font-weight: 400;}
        .plan-day p { margin-bottom: 10px; }
        .plan-day-content { font-size: 0.9rem; }
        .plan-day.completed { background-color: #d4edda; border-color: #155724; }
        .dark-mode .plan-day.completed { background-color: #15572440; }
        .plan-day.to-review { background-color: #fff3cd; border-color: #856404; }
        .dark-mode .plan-day.to-review { background-color: #85640440; }
        .plan-day.not-read { background-color: #f8d7da; border-color: #721c24; }
        .dark-mode .plan-day.not-read { background-color: #721c2440; }
        .plan-day.current { border-color: var(--primary-color); border-width: 2px; box-shadow: 0 0 15px var(--primary-light); }
        .plan-day.disabled { opacity: 0.6; pointer-events: none; }
        
        .history-list { list-style-type: none; padding-left: 0; }
        .history-list li { background-color: var(--bg); border-left: 5px solid var(--primary-color); padding: 15px; margin-bottom: 10px; border-radius: 8px; }
        [dir="rtl"] .history-list li { border-left: none; border-right: 5px solid var(--primary-color); }
        .history-list li .date { font-size: 0.8em; color: #888; display: block; }
        
        #notification-container { position: fixed; top: 15px; right: 15px; max-width: 320px; z-index: 9999; }
        [dir="rtl"] #notification-container { right: auto; left: 15px; }
        .notification { background: var(--card-bg); border-left: 5px solid var(--primary-color); padding: 16px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); animation: fadeIn 0.5s ease-out; }
        [dir="rtl"] .notification { border-left: none; border-right: 5px solid var(--primary-color); }
        .notification.warning { border-color: var(--warning-color); }
        .notification h4 { margin: 0 0 8px; font-size: 1.1em; color: var(--primary-color); }
        .notification.warning h4 { color: var(--warning-color); }
        .notification p { margin: 0; font-size: 0.95em; }
        
        #whatsapp-share-float { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background-color: #25D366; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2rem; text-decoration: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 999; transition: transform 0.2s; cursor:pointer; }
        #whatsapp-share-float:hover { transform: scale(1.1); }
        [dir="rtl"] #whatsapp-share-float { right: auto; left: 20px; }
        .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background-color: var(--primary-color); color: white; padding: 15px 25px; border-radius: 8px; z-index: 1001; opacity: 0; transition: opacity 0.5s, transform 0.5s; pointer-events: none; }
        .toast.show { opacity: 1; transform: translate(-50%, -10px); }

        .revision-mode-selector { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap; }
        .revision-mode-selector .btn { background-color: var(--border-color); color: var(--text); }
        .revision-mode-selector .btn.active { background-color: var(--primary-color); color: white; }
        
        .memorized-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .memorized-list-item:last-child { border-bottom: none; }
        .memorized-level-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }
        .level-excellent { background-color: #d4edda; color: #155724; }
        .level-bon { background-color: #cce5ff; color: #004085; }
        .level-moyen { background-color: #fff3cd; color: #856404; }
        .add-memorization-form { margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border-color); }
        
        .toggle-switch-container { display: flex; align-items: center; justify-content: space-between; }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        #exit-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #fbeec1, #fff); display: flex; justify-content: center; align-items: center; z-index: 10002; animation: fadeIn 1s forwards; }
        .exit-message { text-align: center; font-family: 'Amiri', serif; animation: zoomOut 3s ease forwards 1s; }
        .exit-message h1 { font-size: 3em; color: #6a4e2d; margin-bottom: 15px; }
        .exit-message p { font-size: 2em; color: #6a4e2d; }
        @keyframes zoomOut { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.3); opacity: 0; } }
        
        .color-palette .color-swatch { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: border-color 0.2s; }
        .color-palette .color-swatch.selected { border-color: var(--primary-color); }
        
        .btn-file-upload { display: flex; justify-content: center; align-items: center; }

        .terms-card-content { text-align: left; font-size: 0.9em; max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; white-space: pre-wrap; }
        #terms-logo { display: block; margin: 0 auto 20px auto; width: 150px; }
        .terms-warning { color: var(--danger-color); font-weight: bold; }

        @media screen and (max-width: 768px) {
            .app-header { flex-direction: column; gap: 15px; padding-top: 50px; }
            .header-greeting { order: 1; text-align: center; font-size: 1.4em; }
            .header-center { order: 2; flex-direction: column; gap: 5px; }
            #profile-section { top: 10px; right: 10px; }
            [dir="rtl"] #profile-section { right: auto; left: 10px; }
            .app-logo { width: 100px; height: 100px; }
            .app-header h1 { font-size: 1.5rem; }
            nav, .wizard-nav { flex-direction: column !important; }
            .stats-grid-combined, .plan-container, #dashboard-content, .progress-circles-container { grid-template-columns: 1fr !important; }
            .nav-tab { font-size: 0.9em; padding: 8px 12px; }
            .progress-circle { width: 100px; height: 100px; }
            .card { padding: 15px; }
        }
    </style>
</head>
<body>
    <div id="language-screen" class="hidden">
      <div class="language-card">
        <h2 id="lang-screen-title"></h2>
        <div class="lang-options">
          <button onclick="window.setStartLanguage('fr')">🇫🇷 Français</button>
          <button onclick="window.setStartLanguage('ar')">🇸🇦 العربية</button>
          <button onclick="window.setStartLanguage('en')">🇬🇧 English</button>
        </div>
      </div>
    </div>
    
    <div id="splash-screen">
        <div class="logo-container">
            <img src="https://i.postimg.cc/MvFHgV5v/logo.png" alt="Logo App" class="logo-img" />
            <h1 id="splash-app-name" class="fade-in delay"></h1>
            <p id="splash-author" class="fade-in delay-2"></p>
        </div>
    </div>

    <div id="welcome-screen" class="welcome-page">
      <div class="welcome-overlay">
        <h1 id="welcome-greeting" class="welcome-title"></h1>
        <p id="welcome-text" class="welcome-text"></p>
        <div class="welcome-buttons">
          <button id="create-profile-btn" class="welcome-btn"></button>
          <button id="login-btn" class="welcome-btn"></button>
        </div>
      </div>
    </div>
    
    <div id="notification-container"></div>
    
    <div id="initial-choice-screen" class="overlay hidden">
        <div class="modal-content">
            <h3 id="program-type-title"></h3>
            <div id="program-type-buttons">
                <div class="choice-btn" onclick="window.startWizard('new', 'full')">
                    <span class="icon">🚀</span> <span id="start-new-text"></span>
                    <p id="start-new-desc"></p>
                </div>
                <div class="choice-btn" onclick="window.startWizard('resume', 'full')">
                    <span class="icon">🔄</span> <span id="resume-program-text"></span>
                    <p id="resume-program-desc"></p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="login-screen" class="overlay hidden">
        <div class="modal-content">
            <h2 id="login-welcome-title" style="font-family: 'Amiri', serif;"></h2>
            <h3 id="login-prompt-title"></h3>
            <div class="form-group"> <input type="password" id="password-input" class="styled-input" placeholder="••••••••"> </div>
            <div class="login-actions">
              <button id="login-button" class="btn btn-primary"></button>
            </div>
            <p id="password-error" class="hidden" style="color: var(--danger-color); margin-top: 10px;"></p>
            <a id="forgot-password-link" class="forgot-password"></a>
             <button id="back-to-welcome-btn" class="btn-back-welcome"></button>
        </div>
    </div>

    <div id="wizard" class="overlay hidden"></div>

    <div id="app-container" class="hidden">
        <header class="app-header">
            <h2 id="header-greeting" class="header-greeting"></h2>
            <div class="header-center">
                <img src="https://i.postimg.cc/MvFHgV5v/logo.png" alt="Logo App" class="app-logo" />
                <h1 id="app-title"></h1>
            </div>
            <div id="profile-section">
                <div id="profile-initial" onclick="toggleProfileMenu()"></div>
                <div id="profile-dropdown" class="hidden">
                    <button id="toggle-theme-btn" onclick="window.toggleQuickTheme()"></button>
                    <button id="logout-btn" onclick="window.handleLogout()"></button>
                    <button id="reset-btn" onclick="window.handleResetApp()"></button>
                </div>
            </div>
        </header>
        <nav id="main-nav"></nav>
        <main>
            <div id="dashboard-view" class="view-content"></div>
            <div id="reading-plan-view" class="view-content hidden"></div>
            <div id="revision-plan-view" class="view-content hidden"></div>
            <div id="memorization-view" class="view-content hidden"></div>
            <div id="history-view" class="view-content hidden"></div>
            <div id="settings-view" class="view-content hidden"></div>
        </main>
    </div>
    
    <div id="whatsapp-share-float" class="share-button hidden" onclick="window.shareViaWhatsApp()">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
    </div>

    <div id="toast" class="toast"></div>

    <div id="exit-screen" class="hidden">
        <div class="exit-message">
            <h1 id="exit-message-h1"></h1>
            <p id="exit-message-p"></p>
        </div>
    </div>

    <p style="text-align:center; font-size: 0.8em; opacity: 0.6; padding: 20px;" id="app-version-footer"></p>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        document.addEventListener("contextmenu", e => e.preventDefault());
        document.onkeydown = function(e) {
          if (e.key === "F12" || (e.ctrlKey && e.shiftKey && e.key === "I") || (e.ctrlKey && e.key === "U")) {
            e.preventDefault();
            return false;
          }
        }

        const TOTAL_PAGES = 604;
        const COLORS = [
            '#2E7D32', '#e63946', '#2a9d8f', '#e9c46a', '#4a4e69', '#ff6f61', '#38bdf8', '#2f5233', 
            '#2196F3', '#FF9800', '#9C27B0', '#795548', 
            '#8ecae6', '#ffb703', '#a2d2ff', '#ffafcc'
        ];
        const THEMES = [ 
            { id: 'light', icon: '☀️' }, { id: 'dark', icon: '🌙' }, { id: 'sepia', icon: '📜' }, { id: 'chalkboard', icon: '🧑‍🏫' },
            { id: 'wood', icon: '🪵' }, { id: 'nightblue', icon: '🌌' }, { id: 'sand', icon: '🏜️' }, { id: 'emerald', icon: '💚' },
            { id: 'sunrise', icon: '🌅' }, { id: 'leafy', icon: '🌿' }, { id: 'pearl', icon: '⚪' }, { id: 'midnight', icon: '🌃' }
        ];
        const SURAH_PAGE_MAP = { 1: "Al-Fatiha", 2: "Al-Baqarah", 49: "Al-Imran", 77: "An-Nisa", 106: "Al-Ma'idah", 128: "Al-An'am", 151: "Al-A'raf", 177: "Al-Anfal", 187: "At-Tawbah", 208: "Yunus", 221: "Hud", 235: "Yusuf", 249: "Ar-Ra'd", 255: "Ibrahim", 262: "Al-Hijr", 267: "An-Nahl", 282: "Al-Isra", 293: "Al-Kahf", 305: "Maryam", 312: "Taha", 322: "Al-Anbya", 332: "Al-Hajj", 342: "Al-Mu'minun", 350: "An-Nur", 359: "Al-Furqan", 367: "Ash-Shu'ara", 377: "An-Naml", 385: "Al-Qasas", 396: "Al-Ankabut", 404: "Ar-Rum", 411: "Luqman", 415: "As-Sajdah", 418: "Al-Ahzab", 428: "Saba", 434: "Fatir", 440: "Ya-Sin", 446: "As-Saffat", 453: "Sad", 458: "Az-Zumar", 467: "Ghafir", 477: "Fussilat", 483: "Ash-Shura", 489: "Az-Zukhruf", 496: "Ad-Dukhan", 499: "Al-Jathiyah", 502: "Al-Ahqaf", 507: "Muhammad", 511: "Al-Fath", 515: "Al-Hujurat", 518: "Qaf", 520: "Adh-Dhariyat", 523: "At-Tur", 526: "An-Najm", 528: "Al-Qamar", 531: "Ar-Rahman", 534: "Al-Waqi'ah", 537: "Al-Hadid", 542: "Al-Mujadila", 545: "Al-Hashr", 549: "Al-Mumtahanah", 551: "As-Saff", 553: "Al-Jumu'ah", 554: "Al-Munafiqun", 556: "At-Taghabun", 558: "At-Talaq", 560: "At-Tahrim", 562: "Al-Mulk", 564: "Al-Qalam", 566: "Al-Haqqah", 568: "Al-Ma'arij", 570: "Nuh", 572: "Al-Jinn", 574: "Al-Muzzammil", 575: "Al-Muddaththir", 577: "Al-Qiyamah", 578: "Al-Insan", 580: "Al-Mursalat", 582: "An-Naba", 583: "An-Nazi'at", 585: "'Abasa", 586: "At-Takwir", 587: "Al-Infitar", 588: "Al-Mutaffifin", 589: "Al-Inshiqaq", 590: "Al-Buruj", 591: "At-Tariq", 592: "Al-A'la", 592: "Al-Ghashiyah", 593: "Al-Fajr", 594: "Al-Balad", 595: "Ash-Shams", 595: "Al-Layl", 596: "Ad-Duha", 596: "Ash-Sharh", 597: "At-Tin", 597: "Al-'Alaq", 598: "Al-Qadr", 598: "Al-Bayyinah", 599: "Az-Zalzalah", 599: "Al-'Adiyat", 600: "Al-Qari'ah", 600: "At-Takathur", 601: "Al-'Asr", 601: "Al-Humazah", 601: "Al-Fil", 602: "Quraysh", 602: "Al-Ma'un", 602: "Al-Kawthar", 603: "Al-Kafirun", 603: "An-Nasr", 603: "Al-Masad", 604: "Al-Ikhlas", 604: "Al-Falaq", 604: "An-Nas" };
        const JUZ_DATA = [ { id: 1, name: "Juz 1", page: 1, surah: "Al-Fatiha" }, { id: 2, name: "Juz 2", page: 22, surah: "Al-Baqara" }, { id: 3, name: "Juz 3", page: 42, surah: "Al-Baqara" }, { id: 4, name: "Juz 4", page: 62, surah: "Al-Imran" }, { id: 5, name: "Juz 5", page: 82, surah: "An-Nisa" }, { id: 6, name: "Juz 6", page: 102, surah: "An-Nisa" }, { id: 7, name: "Juz 7", page: 121, surah: "Al-Ma'idah" }, { id: 8, name: "Juz 8", page: 142, surah: "Al-An'am" }, { id: 9, name: "Juz 9", page: 162, surah: "Al-A'raf" }, { id: 10, name: "Juz 10", page: 182, surah: "Al-Anfal" }, { id: 11, name: "Juz 11", page: 201, surah: "At-Tawbah" }, { id: 12, name: "Juz 12", page: 222, surah: "Hud" }, { id: 13, name: "Juz 13", page: 242, surah: "Yusuf" }, { id: 14, name: "Juz 14", page: 262, surah: "Al-Hijr" }, { id: 15, name: "Juz 15", page: 282, surah: "Al-Isra" }, { id: 16, name: "Juz 16", page: 302, surah: "Al-Kahf" }, { id: 17, name: "Juz 17", page: 322, surah: "Al-Anbya" }, { id: 18, name: "Juz 18", page: 342, surah: "Al-Mu'minun" }, { id: 19, name: "Juz 19", page: 362, surah: "Al-Furqan" }, { id: 20, name: "Juz 20", page: 382, surah: "An-Naml" }, { id: 21, name: "Juz 21", page: 402, surah: "Al-'Ankabut" }, { id: 22, name: "Juz 22", page: 422, surah: "Al-Ahzab" }, { id: 23, name: "Juz 23", page: 442, surah: "Ya-Sin" }, { id: 24, name: "Juz 24", page: 462, surah: "Az-Zumar" }, { id: 25, name: "Juz 25", page: 482, surah: "Fussilat" }, { id: 26, name: "Juz 26", page: 502, surah: "Al-Ahqaf" }, { id: 27, name: "Juz 27", page: 522, surah: "Adh-Dhariyat" }, { id: 28, name: "Juz 28", page: 542, surah: "Al-Mujadila" }, { id: 29, name: "Juz 29", page: 562, surah: "Al-Mulk" }, { id: 30, name: "Juz 30", page: 582, surah: "An-Naba" } ];
        const FULL_SURAH_LIST = [ {id: 1, name: "Al-Fatiha", verses: 7}, {id: 2, name: "Al-Baqarah", verses: 286}, {id: 3, name: "Al-Imran", verses: 200}, {id: 4, name: "An-Nisa", verses: 176}, {id: 5, name: "Al-Ma'idah", verses: 120}, {id: 6, name: "Al-An'am", verses: 165}, {id: 7, name: "Al-A'raf", verses: 206}, {id: 8, name: "Al-Anfal", verses: 75}, {id: 9, name: "At-Tawbah", verses: 129}, {id: 10, name: "Yunus", verses: 109}, {id: 11, name: "Hud", verses: 123}, {id: 12, name: "Yusuf", verses: 111}, {id: 13, name: "Ar-Ra'd", verses: 43}, {id: 14, name: "Ibrahim", verses: 52}, {id: 15, name: "Al-Hijr", verses: 99}, {id: 16, name: "An-Nahl", verses: 128}, {id: 17, name: "Al-Isra", verses: 111}, {id: 18, name: "Al-Kahf", verses: 110}, {id: 19, name: "Maryam", verses: 98}, {id: 20, name: "Taha", verses: 135}, {id: 21, name: "Al-Anbya", verses: 112}, {id: 22, name: "Al-Hajj", verses: 78}, {id: 23, name: "Al-Mu'minun", verses: 118}, {id: 24, name: "An-Nur", verses: 64}, {id: 25, name: "Al-Furqan", verses: 77}, {id: 26, name: "Ash-Shu'ara", verses: 227}, {id: 27, name: "An-Naml", verses: 93}, {id: 28, name: "Al-Qasas", verses: 88}, {id: 29, name: "Al-Ankabut", verses: 69}, {id: 30, name: "Ar-Rum", verses: 60}, {id: 31, name: "Luqman", verses: 34}, {id: 32, name: "As-Sajdah", verses: 30}, {id: 33, name: "Al-Ahzab", verses: 73}, {id: 34, name: "Saba", verses: 54}, {id: 35, name: "Fatir", verses: 45}, {id: 36, name: "Ya-Sin", verses: 83}, {id: 37, name: "As-Saffat", verses: 182}, {id: 38, name: "Sad", verses: 88}, {id: 39, name: "Az-Zumar", verses: 75}, {id: 40, name: "Ghafir", verses: 85}, {id: 41, name: "Fussilat", verses: 54}, {id: 42, name: "Ash-Shura", verses: 53}, {id: 43, name: "Az-Zukhruf", verses: 89}, {id: 44, name: "Ad-Dukhan", verses: 59}, {id: 45, name: "Al-Jathiyah", verses: 37}, {id: 46, name: "Al-Ahqaf", verses: 35}, {id: 47, name: "Muhammad", verses: 38}, {id: 48, name: "Al-Fath", verses: 29}, {id: 49, name: "Al-Hujurat", verses: 18}, {id: 50, name: "Qaf", verses: 45}, {id: 51, name: "Adh-Dhariyat", verses: 60}, {id: 52, name: "At-Tur", verses: 49}, {id: 53, name: "An-Najm", verses: 62}, {id: 54, name: "Al-Qamar", verses: 55}, {id: 55, name: "Ar-Rahman", verses: 78}, {id: 56, name: "Al-Waqi'ah", verses: 96}, {id: 57, name: "Al-Hadid", verses: 29}, {id: 58, name: "Al-Mujadila", verses: 22}, {id: 59, name: "Al-Hashr", verses: 24}, {id: 60, name: "Al-Mumtahanah", verses: 13}, {id: 61, name: "As-Saff", verses: 14}, {id: 62, name: "Al-Jumu'ah", verses: 11}, {id: 63, name: "Al-Munafiqun", verses: 11}, {id: 64, name: "At-Taghabun", verses: 18}, {id: 65, name: "At-Talaq", verses: 12}, {id: 66, name: "At-Tahrim", verses: 12}, {id: 67, name: "Al-Mulk", verses: 30}, {id: 68, name: "Al-Qalam", verses: 52}, {id: 69, name: "Al-Haqqah", verses: 52}, {id: 70, name: "Al-Ma'arij", verses: 44}, {id: 71, name: "Nuh", verses: 28}, {id: 72, name: "Al-Jinn", verses: 28}, {id: 73, name: "Al-Muzzammil", verses: 20}, {id: 74, name: "Al-Muddaththir", verses: 56}, {id: 75, name: "Al-Qiyamah", verses: 40}, {id: 76, name: "Al-Insan", verses: 31}, {id: 77, name: "Al-Mursalat", verses: 50}, {id: 78, name: "An-Naba", verses: 40}, {id: 79, name: "An-Nazi'at", verses: 46}, {id: 80, name: "'Abasa", verses: 42}, {id: 81, name: "At-Takwir", verses: 29}, {id: 82, name: "Al-Infitar", verses: 19}, {id: 83, name: "Al-Mutaffifin", verses: 36}, {id: 84, name: "Al-Inshiqaq", verses: 25}, {id: 85, name: "Al-Buruj", verses: 22}, {id: 86, name: "At-Tariq", verses: 17}, {id: 87, name: "Al-A'la", verses: 19}, {id: 88, name: "Al-Ghashiyah", verses: 26}, {id: 89, name: "Al-Fajr", verses: 30}, {id: 90, name: "Al-Balad", verses: 20}, {id: 91, name: "Ash-Shams", verses: 15}, {id: 92, name: "Al-Layl", verses: 21}, {id: 93, name: "Ad-Duha", verses: 11}, {id: 94, name: "Ash-Sharh", verses: 8}, {id: 95, name: "At-Tin", verses: 8}, {id: 96, name: "Al-'Alaq", verses: 19}, {id: 97, name: "Al-Qadr", verses: 5}, {id: 98, name: "Al-Bayyinah", verses: 8}, {id: 99, name: "Az-Zalzalah", verses: 8}, {id: 100, name: "Al-'Adiyat", verses: 11}, {id: 101, name: "Al-Qari'ah", verses: 11}, {id: 102, name: "At-Takathur", verses: 8}, {id: 103, name: "Al-'Asr", verses: 3}, {id: 104, name: "Al-Humazah", verses: 9}, {id: 105, name: "Al-Fil", verses: 5}, {id: 106, name: "Quraysh", verses: 4}, {id: 107, name: "Al-Ma'un", verses: 7}, {id: 108, name: "Al-Kawthar", verses: 3}, {id: 109, name: "Al-Kafirun", verses: 6}, {id: 110, name: "An-Nasr", verses: 3}, {id: 111, name: "Al-Masad", verses: 5}, {id: 112, name: "Al-Ikhlas", verses: 4}, {id: 113, name: "Al-Falaq", verses: 5}, {id: 114, name: "An-Nas", verses: 6} ];
        const HIZB_DATA = [ { "name": "1", "details": "Al-Fatiha 1 - Al-Baqara 74", "surahs": ["Al-Fatiha", "Al-Baqarah (1-74)"] }, { "name": "2", "details": "Al-Baqara 75 - 141", "surahs": ["Al-Baqarah (75-141)"] }, { "name": "3", "details": "Al-Baqara 142 - 202", "surahs": ["Al-Baqarah (142-202)"] }, { "name": "4", "details": "Al-Baqara 203 - 252", "surahs": ["Al-Baqarah (203-252)"] }, { "name": "5", "details": "Al-Baqara 253 - Al-'Imran 14", "surahs": ["Al-Baqarah (253-286)", "Al-'Imran (1-14)"] }, { "name": "6", "details": "Al-'Imran 15 - 92", "surahs": ["Al-'Imran (15-92)"] }, { "name": "7", "details": "Al-'Imran 93 - 163", "surahs": ["Al-'Imran (93-163)"] }, { "name": "8", "details": "Al-'Imran 164 - An-Nisa 23", "surahs": ["Al-'Imran (164-200)", "An-Nisa' (1-23)"] }, { "name": "9", "details": "An-Nisa 23 - 87", "surahs": ["An-Nisa' (23-87)"] }, { "name": "10", "details": "An-Nisa 88 - 147", "surahs": ["An-Nisa' (88-147)"] }, { "name": "11", "details": "An-Nisa 148 - Al-Maida 26", "surahs": ["An-Nisa' (148-176)", "Al-Ma'idah (1-26)"] }, { "name": "12", "details": "Al-Maida 27 - 81", "surahs": ["Al-Ma'idah (27-81)"] }, { "name": "13", "details": "Al-Maida 82 - Al-An'am 29", "surahs": ["Al-Ma'idah (82-120)", "Al-An'am (1-29)"] }, { "name": "14", "details": "Al-An'am 30 - 110", "surahs": ["Al-An'am (30-110)"] }, { "name": "15", "details": "Al-An'am 111 - 165", "surahs": ["Al-An'am (111-165)"] }, { "name": "16", "details": "Al-A'raf 1 - 84", "surahs": ["Al-A'raf (1-84)"] }, { "name": "17", "details": "Al-A'raf 85 - 170", "surahs": ["Al-A'raf (85-170)"] }, { "name": "18", "details": "Al-A'raf 171 - Al-Anfal 40", "surahs": ["Al-A'raf (171-206)", "Al-Anfal (1-40)"] }, { "name": "19", "details": "Al-Anfal 41 - At-Tawba 33", "surahs": ["An-Anfal (41-75)", "At-Tawbah (1-33)"] }, { "name": "20", "details": "At-Tawba 34 - 89", "surahs": ["At-Tawbah (34-89)"] }, { "name": "21", "details": "At-Tawba 90 - Yunus 25", "surahs": ["At-Tawbah (90-129)", "Yunus (1-25)"] }, { "name": "22", "details": "Yunus 26 - Hud 5", "surahs": ["Yunus (26-109)", "Hud (1-5)"] }, { "name": "23", "details": "Hud 6 - 83", "surahs": ["Hud (6-83)"] }, { "name": "24", "details": "Hud 84 - Yusuf 52", "surahs": ["Hud (84-123)", "Yusuf (1-52)"] }, { "name": "25", "details": "Yusuf 53 - Ar-Ra'd 18", "surahs": ["Yusuf (53-111)", "Ar-Ra'd (1-18)"] }, { "name": "26", "details": "Ar-Ra'd 19 - Ibrahim 52", "surahs": ["Ar-Ra'd (19-43)", "Ibrahim (1-52)"] }, { "name": "27", "details": "Al-Hijr 1 - An-Nahl 50", "surahs": ["Al-Hijr", "An-Nahl (1-50)"] }, { "name": "28", "details": "An-Nahl 51 - 128", "surahs": ["An-Nahl (51-128)"] }, { "name": "29", "details": "Al-Isra 1 - 98", "surahs": ["Al-Isra' (1-98)"] }, { "name": "30", "details": "Al-Isra 99 - Al-Kahf 74", "surahs": ["Al-Isra' (99-111)", "Al-Kahf (1-74)"] }, { "name": "31", "details": "Al-Kahf 75 - Maryam 98", "surahs": ["Al-Kahf (75-110)", "Maryam"] }, { "name": "32", "details": "Taha 1 - 135", "surahs": ["Ta-Ha"] }, { "name": "33", "details": "Al-Anbya 1 - 112", "surahs": ["Al-Anbiya'"] }, { "name": "34", "details": "Al-Hajj 1 - 78", "surahs": ["Al-Hajj"] }, { "name": "35", "details": "Al-Muminun 1 - An-Nur 20", "surahs": ["Al-Mu'minun", "An-Nur (1-20)"] }, { "name": "36", "details": "An-Nur 21 - Al-Furqan 20", "surahs": ["An-Nur (21-64)", "Al-Furqan (1-20)"] }, { "name": "37", "details": "Al-Furqan 21 - Ash-Shu'ara 110", "surahs": ["Al-Furqan (21-77)", "Ash-Shu'ara' (1-110)"] }, { "name": "38", "details": "Ash-Shu'ara 111 - An-Naml 53", "surahs": ["Ash-Shu'ara' (111-227)", "An-Naml (1-53)"] }, { "name": "39", "details": "An-Naml 54 - Al-Qasas 50", "surahs": ["An-Naml (54-93)", "Al-Qasas (1-50)"] }, { "name": "40", "details": "Al-Qasas 51 - Al-'Ankabut 45", "surahs": ["Al-Qasas (51-88)", "Al-'Ankabut (1-45)"] }, { "name": "41", "details": "Al-'Ankabut 46 - Luqman 21", "surahs": ["Al-'Ankabut (46-69)", "Ar-Rum", "Luqman (1-21)"] }, { "name": "42", "details": "Luqman 22 - Al-Ahzab 30", "surahs": ["Luqman (22-34)", "As-Sajdah", "Al-Ahzab (1-30)"] }, { "name": "43", "details": "Al-Ahzab 31 - Saba 23", "surahs": ["Al-Ahzab (31-73)", "Saba' (1-23)"] }, { "name": "44", "details": "Saba 24 - Ya-Sin 27", "surahs": ["Saba' (24-54)", "Fatir", "Ya-Sin (1-27)"] }, { "name": "45", "details": "Ya-Sin 28 - As-Saffat 144", "surahs": ["Ya-Sin (28-83)", "As-Saffat (1-144)"] }, { "name": "46", "details": "As-Saffat 145 - Az-Zumar 31", "surahs": ["As-Saffat (145-182)", "Sad", "Az-Zumar (1-31)"] }, { "name": "47", "details": "Az-Zumar 32 - Ghafir 40", "surahs": ["Az-Zumar (32-75)", "Ghafir (1-40)"] }, { "name": "48", "details": "Ghafir 41 - Fussilat 46", "surahs": ["Ghafir (41-85)", "Fussilat (1-46)"] }, { "name": "49", "details": "Fussilat 47 - Az-Zukhruf 23", "surahs": ["Fussilat (47-54)", "Ash-Shura", "Az-Zukhruf (1-23)"] }, { "name": "50", "details": "Az-Zukhruf 24 - Al-Jathiyah 37", "surahs": ["Az-Zukhruf (24-89)", "Ad-Dukhan", "Al-Jathiyah"] }, { "name": "51", "details": "Al-Ahqaf 1 - Al-Fath 17", "surahs": ["Al-Ahqaf", "Muhammad", "Al-Fath (1-17)"] }, { "name": "52", "details": "Al-Fath 18 - Adh-Dhariyat 30", "surahs": ["Al-Fath (18-29)", "Al-Hujurat", "Qaf", "Adh-Dhariyat (1-30)"] }, { "name": "53", "details": "Adh-Dhariyat 31 - Al-Qamar 55", "surahs": ["Adh-Dhariyat (31-60)", "At-Tur", "An-Najm", "Al-Qamar"] }, { "name": "54", "details": "Ar-Rahman 1 - Al-Hadid 29", "surahs": ["Ar-Rahman", "Al-Waqi'ah", "Al-Hadid"] }, { "name": "55", "details": "Al-Mujadilah 1 - As-Saff 14", "surahs": ["Al-Mujadilah", "Al-Hashr", "Al-Mumtahanah", "As-Saff"] }, { "name": "56", "details": "Al-Jumu'a 1 - At-Tahrim 12", "surahs": ["Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim"] }, { "name": "57", "details": "Al-Mulk 1 - Nuh 28", "surahs": ["Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij", "Nuh"] }, { "name": "58", "details": "Al-Jinn 1 - Al-Mursalat 50", "surahs": ["Al-Jinn", "Al-Muzzammil", "Al-Muddaththir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat"] }, { "name": "59", "details": "An-Naba 1 - At-Tariq 17", "surahs": ["An-Naba'", "An-Nazi'at", "'Abasa", "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Inshiqaq", "Al-Buruj", "At-Tariq"] }, { "name": "60", "details": "Al-A'la 1 - An-Nas 6", "surahs": ["Al-A'la", "Al-Ghashiyah", "Al-Fajr", "Al-Balad", "Ash-Shams", "Al-Layl", "Ad-Duha", "Ash-Sharh", "At-Tin", "Al-'Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-'Adiyat", "Al-Qari'ah", "At-Takathur", "Al-'Asr", "Al-Humazah", "Al-Fil", "Quraysh", "Al-Ma'un", "Al-Kawthar", "Al-Kafirun", "An-Nasr", "Al-Masad", "Al-Ikhlas", "Al-Falaq", "An-Nas"] } ];
        
        let state = {};
        let tempWizardState = {};
        const defaultState = {
            profile: null,
            settings: { lang: 'fr', theme: 'light', accentColor: '#2E7D32', enableNotifications: true },
            progress: { startDate: null, currentReadingDay: 1, consecutiveDays: 0, totalpagesRead: 0, readingHistory: {}, currentRevisionIndex: 0, history: { reading: [], revision: [], toReview: [] } },
            plans: { reading: null, revision: null, originalReading: null }
        };

        const languageScreen = document.getElementById('language-screen');
        const splashScreen = document.getElementById('splash-screen');
        const welcomeScreen = document.getElementById('welcome-screen');
        const initialChoiceScreen = document.getElementById('initial-choice-screen');
        const loginScreen = document.getElementById('login-screen');
        const wizardOverlay = document.getElementById('wizard');
        const appContainer = document.getElementById('app-container');
        const mainNav = document.getElementById('main-nav');
        const toastEl = document.getElementById('toast');
        const whatsappShareFloatBtn = document.getElementById('whatsapp-share-float');
        const exitScreen = document.getElementById('exit-screen');

        const chunkArray = (arr, size) => Array.from({ length: Math.ceil(arr.length / size) }, (v, i) => arr.slice(i * size, i * size + size));

        function saveState() { localStorage.setItem('quranCompanionState_v7', JSON.stringify(state)); }
        function loadState() {
            const savedState = localStorage.getItem('quranCompanionState_v7');
            state = savedState ? JSON.parse(savedState) : JSON.parse(JSON.stringify(defaultState));
            
            const savedLang = localStorage.getItem("language");
            if (savedLang) {
                state.settings.lang = savedLang;
            } else {
                 if (!state.settings.lang) {
                    const browserLang = navigator.language.split('-')[0];
                    state.settings.lang = ['fr', 'en', 'ar'].includes(browserLang) ? browserLang : 'fr';
                }
            }

            if (!state.progress.history) { state.progress.history = { reading: [], revision: [], toReview: [] }; }
            if (!state.progress.history.toReview) { state.progress.history.toReview = []; }
            if (state.settings.enableNotifications === undefined){ state.settings.enableNotifications = true; }
            if (state.profile && !state.profile.memorizations) { state.profile.memorizations = { surahs: [], hizbs: [], juzz: [] }; }
        }
        
        function t(key, replacements = {}) {
            let translation = (TRANSLATIONS[state.settings.lang] && TRANSLATIONS[state.settings.lang][key]) || key;
            Object.keys(replacements).forEach(rKey => {
                translation = translation.replace(`{${rKey}}`, replacements[rKey]);
            });
            return translation;
        }

        function translateStaticUI() {
            // Splash Screen
            document.getElementById('splash-app-name').textContent = t('appName');
            document.getElementById('splash-author').textContent = t('byAbuJunayd');
            
            // Language Screen
            document.getElementById('lang-screen-title').textContent = t('chooseYourLanguage');

            // Welcome Screen
            document.getElementById('welcome-greeting').textContent = t('welcomeGreeting');
            document.getElementById('welcome-text').textContent = t('appDescription');

            // Login Screen
            document.getElementById('back-to-welcome-btn').textContent = t('backToWelcome');
            
            // Footer
            document.getElementById('app-version-footer').textContent = `Version 7.1 – ${t('appName')} by Abu Junayd`;

            // Exit Screen
            document.getElementById('exit-message-h1').textContent = 'بَارَكَ ٱللّٰهُ فِيكُمْ';
            document.getElementById('exit-message-p').textContent = 'وَٱلسَّلَامُ عَلَيْكُمْ وَرَحْمَةُ ٱللّٰهِ';
        }

        function getHizbDetailsFromPage(page) {
            let hizbNum = 0;
            let hizbDetails = "";
            let juz = JUZ_DATA.slice().reverse().find(j => page >= j.page);
            if(juz){
                const pageInJuz = page - juz.page;
                hizbNum = (juz.id - 1) * 2 + (pageInJuz >= 10 ? 2:1);
            }
            if (hizbNum > 0 && HIZB_DATA[hizbNum-1]){
                hizbDetails = HIZB_DATA[hizbNum-1].details;
            }
            return {hizbNum, hizbDetails};
        }
        
        function generateReadingPlan() {
            if (!state.profile || !state.profile.goals.reading) return;
            const { duration, khatmas, kahfOption, kahfPages } = state.profile.goals.reading;
            const startDate = new Date(state.progress.startDate);
            const totalPagesToRead = TOTAL_PAGES * khatmas;
            let pagesForNormalDays = totalPagesToRead;
            
            let fridaysCount = 0;
            if (kahfOption) {
                for (let i = 0; i < duration; i++) {
                    let tempDate = new Date(startDate);
                    tempDate.setDate(startDate.getDate() + i);
                    if (tempDate.getDay() === 5) { fridaysCount++; }
                }
                pagesForNormalDays -= (fridaysCount * (kahfPages || 0));
            }
            
            const normalDaysCount = duration - fridaysCount;
            const pagesPerNormalDay = normalDaysCount > 0 ? Math.floor(pagesForNormalDays / normalDaysCount) : 0;
            let extraPages = normalDaysCount > 0 ? pagesForNormalDays % normalDaysCount : 0;
            
            const plan = [];
            let currentPage = 1;
            for (let day = 1; day <= duration; day++) {
                let pagesToday;
                let isKahfDay = false;

                let tempDate = new Date(startDate);
                tempDate.setDate(startDate.getDate() + day - 1);

                if (kahfOption && tempDate.getDay() === 5) {
                    pagesToday = kahfPages || 0;
                    isKahfDay = true;
                } else {
                    pagesToday = pagesPerNormalDay + (extraPages > 0 ? 1 : 0);
                    if (extraPages > 0) extraPages--;
                }

                const startPage = currentPage;
                const endPage = startPage + pagesToday - 1;
                plan.push({ 
                    day, 
                    startPage: startPage % TOTAL_PAGES || TOTAL_PAGES, 
                    endPage: endPage % TOTAL_PAGES || TOTAL_PAGES, 
                    pages: pagesToday, 
                    recalculatedPages: pagesToday,
                    isKahfDay,
                });
                currentPage = endPage + 1;
            }
            state.plans.reading = JSON.parse(JSON.stringify(plan));
            state.plans.originalReading = JSON.parse(JSON.stringify(plan));
        }
        
        function generateRevisionPlan() {
            if (!state.profile || !state.profile.goals.revision) return;
            const { selection, revisionMode, unitsPerDay, revisionDuration, frequency, boosterSurahs, boosterSurahFreq } = state.profile.goals.revision;

            if (!selection || selection.length === 0) {
                state.plans.revision = null;
                return;
            }

            let units = [];
            if (revisionMode === 'sourate') {
                units = selection.map(surahId => ({ text: FULL_SURAH_LIST.find(s => s.id == surahId).name, surahs: [FULL_SURAH_LIST.find(s => s.id == surahId).name] }));
            } else if (revisionMode === 'juzz') {
                selection.forEach(juzId => {
                    const juz = JUZ_DATA.find(j => j.id == juzId);
                    if (juz) {
                        const hizbStart = (juz.id - 1) * 2;
                        const hizbEnd = hizbStart + 1;
                        const details = `${HIZB_DATA[hizbStart].details} | ${HIZB_DATA[hizbEnd].details}`;
                        units.push({ text: `${t('juzz')} ${juz.id}`, surahs: details });
                    }
                });
            } else { 
                selection.map(Number).sort((a, b) => a - b).forEach(hizbIndex => {
                    const hizbData = HIZB_DATA[hizbIndex];
                    if (hizbData) units.push({ text: `${t('hizb')} ${hizbData.name}`, surahs: hizbData.details });
                });
            }

            if (units.length === 0) { state.plans.revision = null; return; }

            const dailyUnitChunks = chunkArray(units, unitsPerDay || 1);
            const plan = [];
            let revisionDayCounter = 0;
            let dayIterator = 0;
            const baseStartDate = new Date(state.progress.startDate);
            
            while(revisionDayCounter < revisionDuration) {
                let tempDate = new Date(baseStartDate);
                tempDate.setDate(baseStartDate.getDate() + (state.progress.currentReadingDay || 1) - 1 + dayIterator);
                let isRevisionDay = false;
                
                switch (frequency.type) {
                    case 'daily': isRevisionDay = true; break;
                    case 'weekly': if (tempDate.getDay() === frequency.value) isRevisionDay = true; break;
                    case 'custom': if (dayIterator % frequency.value === 0) isRevisionDay = true; break;
                }
                
                if (isRevisionDay) {
                    const chunkIndex = revisionDayCounter % dailyUnitChunks.length;
                    const dayPlan = {
                        day: revisionDayCounter + 1,
                        date: new Date(tempDate),
                        units: JSON.parse(JSON.stringify(dailyUnitChunks[chunkIndex])),
                        status: 'pending',
                        difficulties: []
                    };
                    
                    if (boosterSurahs && boosterSurahs.length > 0 && boosterSurahFreq > 0 && ((revisionDayCounter + 1) % boosterSurahFreq === 0)) {
                        boosterSurahs.forEach(surahId => {
                             const boosterData = FULL_SURAH_LIST.find(s => s.id == surahId);
                             if(boosterData) dayPlan.units.push({text: `📌 ${boosterData.name}`, surahs: boosterData.name });
                        });
                    }

                    plan.push(dayPlan);
                    revisionDayCounter++;
                }
                dayIterator++;
                if (dayIterator > 365*5) break; 
            }
            state.plans.revision = plan;
        }

        function recalculateFuturePlan() {
            if (!state.plans.originalReading) return;

            state.plans.reading = JSON.parse(JSON.stringify(state.plans.originalReading));
            
            let totalPagesRead = 0;
            let totalPagesPlanned = 0;
            
            for (let day = 1; day < state.progress.currentReadingDay; day++) {
                const history = state.progress.readingHistory[`day_${day}`];
                const originalPlanDay = state.plans.originalReading.find(d => d.day === day);
                if (originalPlanDay) {
                    totalPagesPlanned += originalPlanDay.pages;
                    totalPagesRead += (history?.realPages !== undefined ? history.realPages : originalPlanDay.pages);
                }
            }

            const pageDifference = totalPagesPlanned - totalPagesRead;
            
            const remainingDays = state.plans.reading.filter(d => d.day >= state.progress.currentReadingDay && !d.isKahfDay);
            if (remainingDays.length > 0) {
                const adjustmentPerDay = Math.floor(pageDifference / remainingDays.length);
                let extraAdjustment = pageDifference % remainingDays.length;

                remainingDays.forEach(day => {
                    let dayAdjustment = adjustmentPerDay + (extraAdjustment > 0 ? 1 : 0);
                    if (extraAdjustment > 0) extraAdjustment--;
                    
                    const planDay = state.plans.reading.find(d => d.day === day.day);
                    planDay.recalculatedPages = Math.max(0, planDay.pages + dayAdjustment);
                });
            }

            let currentPage = 1;
            for(let day = 1; day <= state.profile.goals.reading.duration; day++) {
                const planDay = state.plans.reading.find(d => d.day === day);
                if (!planDay) continue;

                const history = state.progress.readingHistory[`day_${day}`];
                const pagesForThisDay = (day < state.progress.currentReadingDay && history?.realPages !== undefined) 
                    ? history.realPages 
                    : planDay.recalculatedPages;

                planDay.startPage = currentPage % TOTAL_PAGES || TOTAL_PAGES;
                currentPage += pagesForThisDay;
                planDay.endPage = (currentPage - 1) % TOTAL_PAGES || TOTAL_PAGES;
            }
            saveState();
        }

        function completeReadingGoal() {
          const goal = state.profile.goals.reading;
          if (!goal) return;
          state.progress.history.reading.push({
            khatmas: goal.khatmas,
            duration: goal.duration,
            completedAt: new Date().toLocaleDateString(state.settings.lang)
          });
          showToast(t('congratulations'));
          saveState();
        }

        function completeRevisionGoal() {
          const goal = state.profile.goals.revision;
          if (!goal) return;
          let totalUnits = 0;
          if (state.plans.revision) {
              totalUnits = state.profile.goals.revision.selection.length;
          }
          state.progress.history.revision.push({
            count: totalUnits,
            duration: state.plans.revision.length,
            completedAt: new Date().toLocaleDateString(state.settings.lang)
          });
          showToast(t('congratulations'));
          saveState();
        }

        function applyThemeAndLang() {
            const { lang, theme, accentColor } = state.settings;
            document.documentElement.style.setProperty('--primary-color', accentColor);
            document.body.className = '';
            document.body.classList.add(`${theme}-mode`);
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
        }

        window.switchView = function(viewId) {
            document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            const activeTab = document.querySelector(`.nav-tab[data-view="${viewId}"]`);
            if (activeTab) activeTab.classList.add('active');
            
            if (viewId === 'dashboard-view') renderDashboard();
            else if (viewId === 'reading-plan-view') renderReadingPlan();
            else if (viewId === 'revision-plan-view') renderRevisionPlan();
            else if (viewId === 'memorization-view') renderMemorization();
            else if (viewId === 'settings-view') renderSettings();
            else if (viewId === 'history-view') renderHistory();
        }
        
        function renderDashboard() {
            const view = document.getElementById('dashboard-view');
            checkAllNotifications();
            if (!state.profile) { view.innerHTML = `<div class="card">${t('noGoalsYet')}</div>`; return; }
            
            const readingGoal = state.profile.goals.reading;
            const revisionGoal = state.profile.goals.revision;
            
            const isReadingGoalActive = readingGoal && state.progress.currentReadingDay <= readingGoal.duration;
            const isRevisionGoalActive = revisionGoal && state.plans.revision && state.progress.currentRevisionIndex < state.plans.revision.length;

            let progressCardHTML = '';
            let readingActionCardHTML = '';
            let revisionActionCardHTML = '';
            
            if (isReadingGoalActive || isRevisionGoalActive) {
                const currentDay = state.progress.currentReadingDay;
                const totalDuration = readingGoal ? readingGoal.duration : 0;
                const overallProgressPercent = readingGoal ? Math.floor(((currentDay - 1) / totalDuration) * 100) : 0;
                let totalpagesRead = 0;
                if(readingGoal) Object.values(state.progress.readingHistory).forEach(h => totalpagesRead += (h.realPages || 0));

                const revisionIndex = state.progress.currentRevisionIndex;
                const totalRevisionDays = revisionGoal && state.plans.revision ? state.plans.revision.length : 0;
                const revisionProgressPercent = totalRevisionDays > 0 ? Math.floor((revisionIndex / totalRevisionDays) * 100) : 0;
                
                progressCardHTML = `
                <div class="card progress-card-combined">
                    <div class="card-header"><span class="icon">📊</span><h3>${t('overallProgress')}</h3></div>
                    <div class="progress-circles-container">
                        ${isReadingGoalActive ? `
                        <div class="progress-circle">
                            <svg><circle class="bg-circle" cx="60" cy="60" r="50"></circle><circle id="progress-fg-reading-circle" class="progress-fg" cx="60" cy="60" r="50"></circle></svg>
                            <div class="progress-text"><span class="progress-percent">${overallProgressPercent}%</span><span class="progress-label">${t('readingPlan')}</span></div>
                        </div>` : ''}
                        ${isRevisionGoalActive ? `
                        <div class="progress-circle">
                            <svg><circle class="bg-circle" cx="60" cy="60" r="50"></circle><circle id="progress-fg-revision-circle" class="progress-fg" cx="60" cy="60" r="50"></circle></svg>
                            <div class="progress-text"><span class="progress-percent">${revisionProgressPercent}%</span><span class="progress-label">${t('revisionPlan')}</span></div>
                        </div>` : ''}
                    </div>
                    <div class="stats-grid-combined">
                        ${isReadingGoalActive ? `
                        <div class="stat-item"><span class="value">🔥 ${state.progress.consecutiveDays}</span><span class="label">${t('consecutiveDays')}</span></div>
                        <div class="stat-item"><span class="value">📖 ${totalpagesRead}</span><span class="label">${t('pagesRead')}</span></div>
                        <div class="stat-item"><span class="value">⏳ ${totalDuration - currentDay + 1}</span><span class="label">${t('daysLeft')}</span></div>` : ''}
                        ${isRevisionGoalActive ? `
                        <div class="stat-item"><span class="value">${revisionIndex}</span><span class="label">${t('revisionDaysDone')}</span></div>
                        <div class="stat-item"><span class="value">${totalRevisionDays - revisionIndex}</span><span class="label">${t('daysLeft')}</span></div>` : ''}
                    </div>
                </div>`;

                setTimeout(() => {
                    if (isReadingGoalActive) {
                        const circleReading = document.getElementById('progress-fg-reading-circle');
                        if(circleReading) {
                            const radius = circleReading.r.baseVal.value; const circumference = 2 * Math.PI * radius;
                            const offset = circumference - (overallProgressPercent / 100) * circumference;
                            circleReading.style.strokeDashoffset = offset;
                        }
                    }
                    if (isRevisionGoalActive) {
                         const circleRevision = document.getElementById('progress-fg-revision-circle');
                         if(circleRevision) {
                            const radius = circleRevision.r.baseVal.value; const circumference = 2 * Math.PI * radius;
                            const offset = circumference - (revisionProgressPercent / 100) * circumference;
                            circleRevision.style.strokeDashoffset = offset;
                         }
                    }
                }, 100);
            }

            if (isReadingGoalActive) {
                const readingDayData = state.plans.reading.find(d => d.day === state.progress.currentReadingDay);
                let readingDetailsHTML = '';
                if (readingDayData) {
                    const hizbStart = getHizbDetailsFromPage(readingDayData.startPage);
                    const hizbEnd = getHizbDetailsFromPage(readingDayData.endPage);
                    let hizbText = `${t('hizb')} ${hizbStart.hizbNum} - ${hizbStart.hizbDetails}`;
                    if(hizbStart.hizbNum !== hizbEnd.hizbNum && hizbEnd.hizbNum > 0) {
                        hizbText = `${t('hizb')} ${hizbStart.hizbNum} ... → ${t('hizb')} ${hizbEnd.hizbNum}`;
                    }

                    readingDetailsHTML = `<div class="details">
                        <p><strong>${t('readingSurahs')}:</strong> ${hizbText} | <strong>${t('readingPages')}:</strong> ${t('readFromTo', {start: readingDayData.startPage, end: readingDayData.endPage})} (${t('totalPages', {count: readingDayData.recalculatedPages})})</p>
                    </div>`;
                }

                readingActionCardHTML = `<div class="card action-card">
                    <div class="card-header"><span class="icon">📖</span><h3>${t('myReading')} - ${t('day')} ${state.progress.currentReadingDay}</h3></div>
                    ${readingDetailsHTML}
                    <div class="form-group"><label>${t('status')}:</label>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-success" onclick="window.handleReadingStatusChange(${state.progress.currentReadingDay}, 'done')">${t('goalAchieved')}</button>
                            <button class="btn btn-sm btn-warning" onclick="window.handleReadingStatusChange(${state.progress.currentReadingDay}, 'partial')">${t('partial')}</button>
                            <button class="btn btn-sm btn-primary" onclick="window.handleReadingStatusChange(${state.progress.currentReadingDay}, 'catchup')">${t('catchUp')}</button>
                            <button class="btn btn-sm btn-danger" onclick="window.handleReadingStatusChange(${state.progress.currentReadingDay}, 'not_read')">${t('notRead')}</button>
                        </div>
                    </div>
                     <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="window.advanceToNextDay()">${t('nextDay')}</button>
                    </div>
                </div>`;
            } else {
                 readingActionCardHTML = `<div class="card action-card">
                    <div class="card-header"><span class="icon">📖</span><h3>${t('myReading')}</h3></div>
                    <p><strong>${readingGoal ? t('congratulations') : ''}</strong></p>
                    <button class="btn btn-primary" onclick="window.restartReadingWizard()">${t('newReadingGoal')}</button>
                </div>`;
            }

            if (isRevisionGoalActive) {
                const todayRevisionDay = state.plans.revision[state.progress.currentRevisionIndex];
                const nextRevisionDay = state.plans.revision[state.progress.currentRevisionIndex + 1];
                
                const chunkText = todayRevisionDay.units.map(u => u.text).join(' + ');
                const surahsList = todayRevisionDay.units.map(u => u.surahs).join('; ');

                let nextRevisionHTML = '';
                if (nextRevisionDay) {
                    const nextChunkText = nextRevisionDay.units.map(u => u.text).join(' + ');
                    nextRevisionHTML = `<div class="next-revision-details">
                        ${t('nextRevisionFor', { chunk: `<b>${nextChunkText}</b>` })}<br><small>(${t('onDay')} ${new Date(nextRevisionDay.date).toLocaleDateString(state.settings.lang, {weekday: 'long', day: 'numeric'})})</small>
                    </div>`;
                }

                revisionActionCardHTML = `<div class="card action-card">
                        <div class="card-header"><span class="icon">🧠</span><h3>${t('myRevision')}</h3></div>
                        <div class="details">${t('revisionFor', { chunk: `<b>${chunkText}</b>` })}<br><small>${surahsList}</small></div>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="window.handleRevisionStatus('revised', ${state.progress.currentRevisionIndex})">${t('revised')}</button>
                            <button class="btn btn-warning" onclick="window.handleRevisionStatus('to-review', ${state.progress.currentRevisionIndex})">${t('toReview')}</button>
                            <button class="btn btn-danger" onclick="window.handleRevisionStatus('not_revised', ${state.progress.currentRevisionIndex})">${t('notAchieved')}</button>
                        </div>
                        ${nextRevisionHTML}
                    </div>`;
            } else {
                revisionActionCardHTML = `<div class="card action-card">
                    <div class="card-header"><span class="icon">🧠</span><h3>${t('myRevision')}</h3></div>
                    <p><strong>${revisionGoal ? t('congratulations') : ''}</strong></p>
                    <button class="btn btn-primary" onclick="window.restartRevisionWizard()">${t('newRevisionGoal')}</button>
                </div>`;
            }
            
            view.innerHTML = `<div id="dashboard-content">${progressCardHTML}${readingActionCardHTML}${revisionActionCardHTML}</div>`;
        }
        
        function renderReadingPlan() {
            const view = document.getElementById('reading-plan-view');
            const planTitle = `<h3>${t('readingPlan')}</h3>`;
            const hadithHTML = `<div class="card">
                <h3>🌟 La récompense de la lecture du Coran</h3>
                <p style="font-size: 1.1em; text-align: right; direction: rtl;">عَنْ عَبْدَ اللَّهِ بْنَ مَسْعُودٍ، يَقُولُ: قَالَ رَسُولُ اللَّهِ صَلَّى اللَّهُ عَلَيْهِ وَسَلَّمَ: " مَنْ قَرَأَ حَرْفًا مِنْ كِتَابِ اللَّهِ فَلَهُ بِهِ حَسَنَةٌ، وَالحَسَنَةُ بِعَشْرِ أَمْثَالِهَا، لَا أَقُولُ الم حَرْفٌ، وَلَكِنْ أَلِفٌ حَرْفٌ وَلَامٌ حَرْفٌ وَمِيمٌ حَرْفٌ "</p>
                <p style="font-style:italic; margin-top: 5px;">D'après Abdallah ibn Mas'ud (qu'Allah l'agrée), le Prophète (ﷺ) a dit: « Celui qui lit une seule lettre du Coran obtient une bonne action et la bonne action est décuplée. Je ne dis pas que 'Alif Lam Mim' est une lettre mais Alif est une lettre, Lam est une lettre et Mim est une lettre ».</p>
                <p style="font-size: 0.8em; opacity: 0.7; margin-top: 5px;">(Rapporté par Tirmidhi n°2910, authentifié par Cheikh Albani)</p>
            </div>`;

            if(!state.profile.goals.reading || state.progress.currentReadingDay > state.profile.goals.reading.duration) { 
                 view.innerHTML = `${hadithHTML}<div class="card" style="text-align:center;">
                    <h3>${t('congratulations')}</h3>
                    <button class="btn btn-primary" onclick="window.restartReadingWizard()">${t('newReadingGoal')}</button>
                 </div>`; 
                 return;
             }
             
             let content = `<div class="plan-container">`;
             const startDate = new Date(state.progress.startDate);

             state.plans.reading.forEach(day => {
                const dayKey = `day_${day.day}`;
                const history = state.progress.readingHistory[dayKey] || {};
                const realPages = history.realPages;
                let statusClass = '';
                let disabledClass = '';
                let dayStatusClass = '';

                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + day.day - 1);
                const dateString = currentDate.toLocaleDateString(state.settings.lang, { weekday: 'long', day: 'numeric', month: 'long' });
                
                const hizbStart = getHizbDetailsFromPage(day.startPage);
                const hizbEnd = getHizbDetailsFromPage(day.endPage);
                let hizbText = `${t('hizb')} ${hizbStart.hizbNum} - ${hizbStart.hizbDetails}`;
                if(hizbStart.hizbNum !== hizbEnd.hizbNum && hizbEnd.hizbNum > 0) {
                     hizbText = `${t('hizb')} ${hizbStart.hizbNum} ... → ${t('hizb')} ${hizbEnd.hizbNum}`;
                }

                if (day.day < state.progress.currentReadingDay) {
                    statusClass = 'completed';
                    if (history.status === 'not_read') dayStatusClass = 'not-read';
                }
                else if (day.day === state.progress.currentReadingDay) { statusClass = 'current'; }
                else { disabledClass = 'disabled'; }
                
                content += `<div class="plan-day ${statusClass} ${disabledClass} ${dayStatusClass}">
                        <div class="plan-day-header">${t('day')} ${day.day}<span class="date-string">${dateString}</span></div>
                        <p><strong>${t('readingSurahs')}:</strong> ${hizbText} | <strong>${t('readingPages')}:</strong> ${t('readFromTo', {start: day.startPage, end: day.endPage})} (${t('totalPages', {count: day.recalculatedPages})})</p>
                        <p><strong>${realPages !== undefined ? realPages + " pages lues" : "⏳ En attente..."}</strong></p>
                        <div class="form-group">
                            <label>${t('status')}:</label>
                             <div class="action-buttons">
                                <button class="btn btn-sm btn-success" onclick="window.handleReadingStatusChange(${day.day}, 'done')">${t('goalAchieved')}</button>
                                <button class="btn btn-sm btn-warning" onclick="window.handleReadingStatusChange(${day.day}, 'partial')">${t('partial')}</button>
                                <button class="btn btn-sm btn-primary" onclick="window.handleReadingStatusChange(${day.day}, 'catchup')">${t('catchUp')}</button>
                                <button class="btn btn-sm btn-danger" onclick="window.handleReadingStatusChange(${day.day}, 'not_read')">${t('notRead')}</button>
                            </div>
                        </div>
                    </div>`;
             });
             content += '</div>';
             
             const globalProgressHTML = renderGlobalProgress();
             view.innerHTML = `${hadithHTML}<div class="card">${planTitle}${content}</div>${globalProgressHTML}`;
        }
        
        function renderGlobalProgress() {
            const readingGoal = state.profile.goals.reading;
            if (!readingGoal) return '';

            let totalPagesRead = 0;
            Object.values(state.progress.readingHistory).forEach(day => {
                if(day.realPages) totalPagesRead += day.realPages;
            });
            state.progress.totalpagesRead = totalPagesRead;

            const currentDayIndex = state.progress.currentReadingDay - 1;
            const duration = readingGoal.duration;
            const totalPagesToRead = readingGoal.khatmas * TOTAL_PAGES;
            const percentage = totalPagesToRead > 0 ? Math.round((totalPagesRead / totalPagesToRead) * 100) : 0;
            const averagePace = currentDayIndex > 0 ? Math.round(totalPagesRead / currentDayIndex) : 0;
            
            let estimatedFinishDateStr = "N/A";
            if (averagePace > 0) {
                const remainingPages = totalPagesToRead - totalPagesRead;
                const remainingDays = Math.ceil(remainingPages / averagePace);
                const finishDate = new Date();
                finishDate.setDate(new Date().getDate() + remainingDays);
                estimatedFinishDateStr = finishDate.toLocaleDateString(state.settings.lang, { year: 'numeric', month: 'long', day: 'numeric' });
            }

            return `<div class="card">
              <div class="card-header"><h3>${t('globalProgress')}</h3></div>
              <div class="stats-grid-combined" style="border:none; padding:0; margin:0;">
                <div class="stat-item"><span class="value">${percentage}%</span><span class="label">${t('overallProgress')}</span></div>
                <div class="stat-item"><span class="value">${totalPagesRead} / ${totalPagesToRead}</span><span class="label">${t('pagesRead')}</span></div>
                <div class="stat-item"><span class="value">~${averagePace}</span><span class="label">${t('pagesPerDay')}</span></div>
                <div class="stat-item"><span class="value" style="font-size: 1.1rem;">${estimatedFinishDateStr}</span><span class="label">${t('estimatedFinishDate')}</span></div>
              </div>
            </div>`;
        }
        
        function renderRevisionPlan() {
            const view = document.getElementById('revision-plan-view');
            const plan = state.plans.revision;
            const hadithHTML = `<div class="card">
                <h3>🔁 L’importance de la révision</h3>
                <p style="font-size: 1.1em; text-align: right; direction: rtl;">عَنْ أَبِي مُوسَى الأَشْعَرِيِّ، عَنِ النَّبِيِّ صَلَّى اللهُ عَلَيْهِ وَسَلَّمَ قَالَ: «تَعَاهَدُوا القُرْآنَ، فَوَالَّذِي نَفْسِي بِيَدِهِ لَهُوَ أَشَدُّ تَفَصِّيًا مِنَ الإِبِلِ فِي عُقُلِهَا»</p>
                <p style="font-style:italic; margin-top: 5px;">D'après Abu Moussa Al Ach'ari (qu'Allah l'agrée), le Prophète (ﷺ) a dit: « Réviser régulièrement le Coran car, par Celui qui détient mon âme dans Sa main, il s'échappe plus vite que les chameaux de leurs enclos ».</p>
                <p style="font-size: 0.8em; opacity: 0.7; margin-top: 5px;">(Rapporté par Boukhari n°5033 et Mouslim n°791)</p>
            </div>`;
            
            let planHTML = '';
            if(!plan || !state.profile.goals.revision || state.progress.currentRevisionIndex >= plan.length) { 
                planHTML = `<div class="card" style="text-align:center;">
                    <h3>${!plan ? t('noGoalsYet') : t('congratulations')}</h3>
                    <button class="btn btn-primary" onclick="window.restartRevisionWizard()">${t('newRevisionGoal')}</button>
                 </div>`;
            } else {
                let content = `<div class="plan-container">`;
                plan.forEach((dayPlan, index) => {
                    let statusClass = '';
                    let disabledClass = '';
                    const chunkText = dayPlan.units.map(u => u.text).join(' + ');
                    const surahsList = dayPlan.units.map(u => u.surahs).join('; ');
                    const dateString = new Date(dayPlan.date).toLocaleDateString(state.settings.lang, { weekday: 'long', day: 'numeric', month: 'long' });

                    switch (dayPlan.status) {
                        case 'revised': statusClass = 'completed'; break;
                        case 'to-review': statusClass = 'to-review'; break;
                        case 'not_revised': statusClass = 'not-read'; break;
                    }
                    
                    if (index < state.progress.currentRevisionIndex) {
                    } else if (index === state.progress.currentRevisionIndex) {
                        statusClass += ' current';
                    } else {
                        disabledClass = 'disabled';
                    }
                    
                    let dayHTML = `<div class="plan-day ${statusClass} ${disabledClass}">
                            <div class="plan-day-header">${t('day')} ${dayPlan.day}<span class="date-string">${dateString}</span></div>
                            <div class="plan-day-content">
                                <b>${chunkText}</b><br>
                                <small>${surahsList}</small>
                            </div>`;
                    
                    if (dayPlan.difficulties && dayPlan.difficulties.length > 0) {
                        dayHTML += `<p style="margin-top:10px; font-size: 0.9em;"><strong>📌 ${t('toReview')}:</strong> ${dayPlan.difficulties.join(", ")}</p>`;
                    }
                    
                    dayHTML += `<div class="action-buttons" style="margin-top:15px;">
                                <button class="btn btn-sm btn-success" ${disabledClass} onclick="window.handleRevisionStatus('revised', ${index})">${t('revised')}</button>
                                <button class="btn btn-sm btn-warning" ${disabledClass} onclick="window.handleRevisionStatus('to-review', ${index})">${t('toReview')}</button>
                                <button class="btn btn-sm btn-danger" ${disabledClass} onclick="window.handleRevisionStatus('not_revised', ${index})">${t('notAchieved')}</button>
                            </div>
                        </div>`;
                    content += dayHTML;
                });
                content += '</div>';
                planHTML = `<div class="card"><h3>${t('revisionPlan')}</h3>${content}</div>`;
            }

            const toReviewHistory = state.progress.history.toReview || [];
            let toReviewHistoryHTML = `<div class="card"><h3>${t('toReviewHistory')}</h3>`;
            if (toReviewHistory.length === 0) {
                toReviewHistoryHTML += `<p>${t('noToReviewHistory')}</p>`;
            } else {
                toReviewHistoryHTML += `<ul class="history-list">`;
                toReviewHistory.forEach(item => {
                    const chunkText = item.units.map(u => u.text).join(' + ');
                    toReviewHistoryHTML += `<li><strong>${t('day')} ${item.day}:</strong> ${chunkText} <span class="date">${new Date(item.date).toLocaleDateString(state.settings.lang)}</span></li>`;
                });
                toReviewHistoryHTML += `</ul>`;
            }
            toReviewHistoryHTML += `</div>`;
            
            view.innerHTML = `${hadithHTML}${planHTML}${toReviewHistoryHTML}`;
        }
        
        function renderHistory() {
            const view = document.getElementById('history-view');
            const history = state.progress.history;
            
            let readingHistoryHtml = `<h3>${t('readingHistoryTitle')}</h3>`;
            if (!history.reading || history.reading.length === 0) {
                readingHistoryHtml += `<p>${t('noReadingHistory')}</p>`;
            } else {
                readingHistoryHtml += `<ul class="history-list">${history.reading.map((o, i) => `
                  <li>
                    ${t('readingGoalHistory', {index: i + 1, khatmas: o.khatmas, duration: o.duration})}
                    <span class="date">${t('completedOn', {date: o.completedAt})}</span>
                  </li>
                `).join('')}</ul>`;
            }

            let revisionHistoryHtml = `<h3>${t('revisionHistoryTitle')}</h3>`;
            if (!history.revision || history.revision.length === 0) {
                revisionHistoryHtml += `<p>${t('noRevisionHistory')}</p>`;
            } else {
                revisionHistoryHtml += `<ul class="history-list">${history.revision.map((o, i) => `
                  <li>
                    ${t('revisionGoalHistory', {index: i + 1, count: o.count, duration: o.duration})}
                    <span class="date">${t('completedOn', {date: o.completedAt})}</span>
                  </li>
                `).join('')}</ul>`;
            }

            view.innerHTML = `<div class="card">
                <div class="card-header"><span class="icon">📂</span><h3>${t('completedGoals')}</h3></div>
                ${readingHistoryHtml}
                <hr style="margin: 20px 0;">
                ${revisionHistoryHtml}
            </div>`;
        }
        
        function renderSettings() {
            const view = document.getElementById('settings-view');
            view.innerHTML = `<div class="card">
                    <div class="card-header"><span class="icon">👤</span><h3>${t('personalInfo')}</h3></div>
                    <div class="form-group">
                        <label for="settings-name">${t('nameKunya')}</label>
                        <input type="text" id="settings-name" class="styled-input" value="${state.profile.name}">
                    </div>
                    <p><strong>${t('gender')}:</strong> ${t(state.profile.gender)}</p>
                </div>
                
                <div class="card">
                    <div class="card-header"><span class="icon">🔑</span><h3>${t('password')}</h3></div>
                    <div class="form-group">
                        <label for="current-password">${t('password')}</label>
                        <input type="password" id="current-password" class="styled-input" placeholder="${t('oldPasswordPlaceholder')}">
                    </div>
                    <div class="form-group">
                        <label for="new-password">${t('createPassword')}</label>
                        <input type="password" id="new-password" class="styled-input" placeholder="${t('newPasswordPlaceholder')}">
                    </div>
                    <div class="form-group">
                        <label for="confirm-new-password">${t('confirmPassword')}</label>
                        <input type="password" id="confirm-new-password" class="styled-input" placeholder="${t('confirmNewPasswordPlaceholder')}">
                    </div>
                    <button class="btn btn-primary" onclick="window.changePassword()">${t('saveData')}</button>
                </div>

                <div class="card">
                    <div class="card-header"><span class="icon">🎯</span><h3>${t('goalManagement')}</h3></div>
                    <div class="action-buttons">
                        <button class="btn btn-warning" onclick="window.restartReadingWizard(true)">${t('changeReadingGoal')}</button>
                        <button class="btn btn-warning" onclick="window.restartRevisionWizard(true)">${t('changeRevisionGoal')}</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="icon">🎨</span><h3>${t('appearance')}</h3></div>
                    <div class="form-group"><label>${t('accentColor')}</label>
                        <div class="color-palette grid-selection" style="grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));">${COLORS.map(c => `<div class="color-swatch ${state.settings.accentColor === c ? 'selected' : ''}" style="background-color:${c};" onclick="window.updateAccentColor('${c}')"></div>`).join('')}</div>
                    </div>
                    <div class="form-group"><label>${t('theme')}</label>
                        <div class="choice-btn-group" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">${THEMES.map(theme => `<div class="choice-btn ${state.settings.theme === theme.id ? 'selected': ''}" onclick="window.updateTheme('${theme.id}')"><span class="icon">${theme.icon}</span>${t(theme.id)}</div>`).join('')}</div>
                    </div>
                     <div class="form-group toggle-switch-container">
                        <label>${t('enableNotifications')}</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="enableNotificationsToggle" ${state.settings.enableNotifications ? 'checked' : ''} onchange="window.toggleNotifications(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="icon">🌐</span><h3>${t('language')}</h3></div>
                    <div class="form-group">
                        <label for="selectLang">${t('changeLang')}:</label>
                        <select id="selectLang" class="styled-input" onchange="window.changeLanguageSetting(this.value)">
                            <option value="fr" ${state.settings.lang === 'fr' ? 'selected' : ''}>🇫🇷 ${t('french')}</option>
                            <option value="en" ${state.settings.lang === 'en' ? 'selected' : ''}>🇬🇧 ${t('english')}</option>
                            <option value="ar" ${state.settings.lang === 'ar' ? 'selected' : ''}>🇸🇦 ${t('arabic')}</option>
                        </select>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="icon">🧾</span><h3>${t('dataExport')}</h3></div>
                    <p>${t('manageDataSecurely')}</p>
                    <div class="action-buttons" style="flex-direction: column; gap: 15px; align-items: stretch;">
                        <button class="btn btn-secondary" onclick="window.shareViaWhatsApp()">
                           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 8px; vertical-align: middle;"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                           ${t('shareProgress')}
                        </button>
                        <button class="btn btn-secondary" onclick="window.generateProgressPDF()">${t('exportPDF')}</button>
                        <button class="btn btn-secondary" onclick="window.exportUserData()">${t('saveData')}</button>
                        <label class="btn btn-secondary btn-file-upload" style="cursor: pointer;">${t('restoreData')}<input type="file" accept=".json" onchange="window.importUserData(event)" style="display: none;"></label>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="icon">⚖️</span><h3>${t('termsOfUse')}</h3></div>
                    <div class="terms-card-content">
                        <img src="https://i.postimg.cc/MvFHgV5v/logo.png" alt="Logo" id="terms-logo">
                        <p id="terms-p1"></p>
                        <p id="terms-p2" class="terms-warning"></p>
                        <p id="terms-p3"></p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="icon">⚙️</span><h3 id="actions-title"></h3></div>
                     <div class="action-buttons" style="flex-direction: column; gap: 15px; align-items: stretch;">
                        <button class="btn btn-warning" onclick="window.resetUserProgress()">${t('resetProgress')}</button>
                        <button class="btn btn-danger" onclick="window.handleLogout()">${t('logout')}</button>
                        <button class="btn btn-danger" onclick="window.handleResetApp()">${t('resetApp')}</button>
                    </div>
                </div>`;
            
            document.getElementById('terms-p1').textContent = t('termsTextP1');
            document.getElementById('terms-p2').textContent = t('termsTextP2');
            document.getElementById('terms-p3').textContent = t('termsTextP3');
            document.getElementById('actions-title').textContent = t('actionsTitle');

            view.querySelector('#settings-name').addEventListener('change', (e) => {
                state.profile.name = e.target.value;
                saveState(); showToast(t('saved'));
                document.getElementById('profile-initial').textContent = state.profile.name.charAt(0).toUpperCase();
            });
        }
        
        function showToast(message) { toastEl.textContent = message; toastEl.className = 'toast show'; setTimeout(() => { toastEl.className = 'toast'; }, 3000); }
        function getTodayDateString(date = new Date()) { return date.toISOString().split('T')[0]; }
        
        function showNotification(options) {
            if (!state.settings.enableNotifications) return;

            const container = document.getElementById("notification-container");
            const el = document.createElement("div");
            el.className = `notification ${options.type || ''}`;
            el.innerHTML = `<h4>${options.title}</h4><p>${options.message}</p>`;
            container.appendChild(el);
            setTimeout(() => el.remove(), 8000);
        }

        function checkAllNotifications() {
            const today = new Date();
            if (today.getDay() === 5 && state.profile.goals.reading && state.profile.goals.reading.kahfOption) {
                showNotification({ type: 'info', title: t('readKahf'), message: `Celui qui lit la sourate <strong>Al-Kahf</strong> aujourd'hui sera éclairé d’une lumière entre les deux vendredis.` });
            }

            if(state.plans.reading && state.progress.currentReadingDay > 1) {
                const yesterdayDay = state.progress.currentReadingDay - 1;
                const yesterdayPlan = state.plans.reading.find(d => d.day === yesterdayDay);
                const yesterdayHistory = state.progress.readingHistory[`day_${yesterdayDay}`];
                if (yesterdayPlan && yesterdayHistory && yesterdayHistory.realPages < yesterdayPlan.recalculatedPages) {
                    const missing = yesterdayPlan.recalculatedPages - yesterdayHistory.realPages;
                    showNotification({ type: 'warning', title: t('partial'), message: `Vous avez <strong>${missing} page(s)</strong> à rattraper d’hier.` });
                }
            }

            if (state.plans.revision && state.progress.currentRevisionIndex < state.plans.revision.length) {
                const todayRevisionDay = state.plans.revision[state.progress.currentRevisionIndex];
                const todaySurahs = new Set(todayRevisionDay.units.flatMap(u => u.surahs).map(s => s.replace(/ \(.*/, '').replace('📌 ', '')));

                for (let i = 0; i < state.progress.currentRevisionIndex; i++) {
                    const pastDayPlan = state.plans.revision[i];
                    if (pastDayPlan.difficulties && pastDayPlan.difficulties.length > 0) {
                        pastDayPlan.difficulties.forEach(difficultSurah => {
                            const cleanSurahName = difficultSurah.replace(/ \(.*/, '').replace('📌 ', '');
                            if (todaySurahs.has(cleanSurahName)) {
                                showNotification({ type: 'warning', title: t('revisionReminder'), message: t('difficultSurahReminder', { surah: cleanSurahName, day: pastDayPlan.day }) });
                            }
                        });
                    }
                }
            }
        }

        window.toggleNotifications = function(isEnabled) {
            state.settings.enableNotifications = isEnabled;
            saveState();
        };

        window.handleReadingStatusChange = function(day, status) {
            const dayKey = `day_${day}`;
            const planDay = state.plans.reading.find(d => d.day === day);
            let adjustment = 0;

            if (status === 'partial') {
                const missingPages = prompt(t('partialLabel'));
                if (missingPages === null) return;
                adjustment = parseInt(missingPages) || 0;
            } else if (status === 'catchup') {
                const extraPages = prompt(t('catchUpLabel'));
                if (extraPages === null) return;
                adjustment = parseInt(extraPages) || 0;
            }

            let realPages = planDay.recalculatedPages;
            if (status === 'partial') realPages = Math.max(0, planDay.recalculatedPages - adjustment);
            else if (status === 'catchup') realPages = planDay.recalculatedPages + adjustment;
            else if (status === 'not_read') realPages = 0;
            
            state.progress.readingHistory[dayKey] = {
                status: status,
                adjustment: adjustment,
                realPages: realPages,
                kahf: planDay.isKahfDay && status === 'done'
            };
            
            recalculateFuturePlan();
            renderDashboard();
            renderReadingPlan();
            showToast(t('saved'));
        };

        window.advanceToNextDay = function() {
            const currentDay = state.progress.currentReadingDay;
            const dayKey = `day_${currentDay}`;

            if (!state.progress.readingHistory[dayKey]) {
                const planDay = state.plans.reading.find(d => d.day === currentDay);
                state.progress.readingHistory[dayKey] = {
                    status: 'done', adjustment: 0, realPages: planDay.recalculatedPages, kahf: planDay.isKahfDay
                };
            }

            if (currentDay === state.profile.goals.reading.duration) {
                completeReadingGoal();
            }

            if (currentDay <= state.profile.goals.reading.duration) {
                state.progress.currentReadingDay++;
                const yesterdayStatus = state.progress.readingHistory[dayKey]?.status;
                if(yesterdayStatus === 'done' || yesterdayStatus === 'catchup') {
                    state.progress.consecutiveDays = (state.progress.consecutiveDays || 0) + 1;
                } else {
                    state.progress.consecutiveDays = 0;
                }
            }

            recalculateFuturePlan();
            saveState();
            renderDashboard();
            renderReadingPlan();
        };

        window.handleRevisionStatus = function(status, revisionIndex) {
            if (revisionIndex === undefined) revisionIndex = state.progress.currentRevisionIndex;
            
            const dayPlan = state.plans.revision[revisionIndex];
            if (!dayPlan) return;

            if (status === 'to-review') {
                if (!state.progress.history.toReview.some(item => item.day === dayPlan.day)) {
                     state.progress.history.toReview.push({
                        day: dayPlan.day,
                        units: dayPlan.units,
                        date: new Date().toISOString()
                    });
                }
            }
            
            dayPlan.status = status;
            if (status === 'revised') {
                dayPlan.difficulties = [];
            }

            if (revisionIndex === state.progress.currentRevisionIndex) {
                 if (state.plans.revision && revisionIndex + 1 === state.plans.revision.length) {
                    completeRevisionGoal();
                }
                state.progress.currentRevisionIndex++;
            }
            
            saveState();
            renderDashboard();
            renderRevisionPlan();
            showToast(t('saved'));
        };
        
        window.resetUserProgress = function() {
            if (!confirm(t('confirmResetProgress'))) return;
            state.progress = { ...defaultState.progress, startDate: getTodayDateString(), history: state.progress.history };
            generateReadingPlan(); generateRevisionPlan(); saveState(); renderDashboard();
            showToast(t('progressResetSuccess'));
        };

        window.restartReadingWizard = function(confirmFirst = false) {
            if (confirmFirst && !confirm(t('confirmChangeGoal'))) return;
            state.profile.goals.reading = null;
            state.plans.reading = null;
            state.plans.originalReading = null;
            state.progress.readingHistory = {};
            state.progress.currentReadingDay = 1;
            state.progress.consecutiveDays = 0;
            state.progress.totalpagesRead = 0;
            saveState();
            startWizard('new', 'reading');
        };

        window.restartRevisionWizard = function(confirmFirst = false) {
            if (confirmFirst && !confirm(t('confirmChangeGoal'))) return;
            state.profile.goals.revision = null;
            state.plans.revision = null;
            state.progress.currentRevisionIndex = 0;
            state.progress.history.toReview = [];
            saveState();
            startWizard('new', 'revision');
        };

        window.handleResetApp = function() { if(confirm(t('confirmReset'))) { localStorage.clear(); window.location.reload(); }};
        window.updateAccentColor = function(color) { state.settings.accentColor = color; applyThemeAndLang(); renderSettings(); saveState(); };
        window.updateTheme = function(themeId) { state.settings.theme = themeId; applyThemeAndLang(); renderSettings(); saveState(); }
        
        window.changeLanguageSetting = function(lang) { 
            state.settings.lang = lang; 
            localStorage.setItem("language", lang); 
            saveState(); 
            applyThemeAndLang();
            translateStaticUI();
            if (appContainer.classList.contains('hidden')) {
                showWelcomeScreen();
            } else {
                initAppUI();
            }
        }
        
        window.handleLogout = function() {
            if (!confirm(t('logoutConfirm'))) return;
            
            appContainer.style.display = "none";
            whatsappShareFloatBtn.classList.add('hidden');
            exitScreen.classList.remove("hidden");

            setTimeout(() => {
                localStorage.removeItem('quranCompanionState_v7');
                window.location.reload();
            }, 4000);
        }

        window.shareViaWhatsApp = function() {
            const choice = prompt(t('sharePrompt'));
            if (!choice) return;

            let message = `📖 *Suivi de ma progression - ${t('appName')}*\n\n`;

            if (choice.toLowerCase().includes("lecture") || choice.toLowerCase().includes("reading") || choice.toLowerCase().includes("قراءة")) {
                message += `*${t('readingHistoryTitle')}*\n`;
                if(state.plans.reading && state.progress.currentReadingDay > 1) {
                    for (let i = 1; i < state.progress.currentReadingDay; i++) {
                        const dayData = state.progress.readingHistory[`day_${i}`] || { status: 'unknown', realPages: 0 };
                        let statusIcon = '❔';
                        let details = '';
                        if (dayData.status === 'done') { statusIcon = '✅'; details = dayData.kahf ? ' + Al Kahf' : ''; }
                        else if (dayData.status === 'not_read') { statusIcon = '🚫'; }
                        else if (dayData.status === 'partial') { statusIcon = '📉'; details = ` - ${dayData.adjustment} pages`;}
                        else if (dayData.status === 'catchup') { statusIcon = '📈'; details = ` + ${dayData.adjustment} pages`;}
                        
                        message += `${t('day')} ${i}: lecture${statusIcon}${details}\n`;
                    }
                } else {
                    message += `${t('noReadingHistory')}\n`;
                }
            }

            if (choice.toLowerCase().includes("revision") || choice.toLowerCase().includes("مراجعة")) {
                 message += `\n*${t('revisionHistoryTitle')}*\n`;
                if(state.plans.revision && state.progress.currentRevisionIndex > 0) {
                    for (let i = 0; i < state.progress.currentRevisionIndex; i++) {
                        const dayPlan = state.plans.revision[i];
                        const statusIcon = dayPlan.status === 'revised' ? '✅' : (dayPlan.status === 'to-review' ? '🔁' : '❌');
                        message += `${t('day')} ${dayPlan.day}: ${dayPlan.units.map(u => u.text).join(' + ')} ${statusIcon}\n`;
                    }
                } else {
                    message += `${t('noRevisionHistory')}\n`;
                }
            }

            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, "_blank");
        }
        
        window.generateProgressPDF = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.text(`Suivi de ${state.profile.name}`, 15, 20);

            doc.setFontSize(12);
            doc.text(t('readingHistoryTitle'), 15, 30);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            let y = 38;

            if (state.plans.reading && state.progress.currentReadingDay > 1) {
                for (let i = 1; i < state.progress.currentReadingDay; i++) {
                    if (y > 280) { doc.addPage(); y = 20; }
                    const dayData = state.progress.readingHistory[`day_${i}`] || { status: 'unknown' };
                    const statusText = dayData.status === 'done' ? 'Fait' : (dayData.status === 'not_read' ? 'Non Fait' : 'Partiel');
                    doc.text(`${t('day')} ${i}: ${statusText}`, 15, y);
                    y += 7;
                }
            } else {
                 doc.text(t('noReadingHistory'), 15, y);
                 y += 7;
            }

            y += 10;
            if (y > 280) { doc.addPage(); y = 20; }
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text(t('revisionHistoryTitle'), 15, y);
            y += 8;
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);

            if(state.plans.revision && state.progress.currentRevisionIndex > 0) {
                for (let i = 0; i < state.progress.currentRevisionIndex; i++) {
                     if (y > 280) { doc.addPage(); y = 20; }
                    const dayPlan = state.plans.revision[i];
                    const statusText = dayPlan.status === 'revised' ? 'Fait' : (dayPlan.status === 'to-review' ? 'A reprendre' : 'Non Fait');
                    const text = `${t('day')} ${dayPlan.day}: ${dayPlan.units.map(u => u.text).join(' + ')} - ${statusText}`;
                    doc.text(text, 15, y);
                    y += 7;
                }
            } else {
                doc.text(t('noRevisionHistory'), 15, y);
            }

            doc.save(`suivi-coran-${state.profile.name}.pdf`);
        }
        
        window.exportUserData = function() {
            try {
                const dataToSave = localStorage.getItem('quranCompanionState_v7');
                if (!dataToSave) {
                    alert(t('noDataToSave'));
                    return;
                }
                const blob = new Blob([dataToSave], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'lecture-quran-sauvegarde.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast(t('saved'));
            } catch (error) {
                console.error("Erreur lors de la sauvegarde : ", error);
                alert(t('errorOnSave'));
            }
        }
        
        window.importUserData = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = e.target.result;
                    JSON.parse(importedData); 
                    localStorage.setItem('quranCompanionState_v7', importedData);
                    alert(t('restoreSuccess'));
                    location.reload();
                } catch (error) {
                    console.error("Erreur lors de la restauration : ", error);
                    alert(t('restoreError'));
                }
            };
            reader.readAsText(file);
        }

        window.changePassword = function() {
            const currentPasswordInput = document.getElementById('current-password');
            const newPasswordInput = document.getElementById('new-password');
            const confirmNewPasswordInput = document.getElementById('confirm-new-password');

            const currentPassword = currentPasswordInput.value;
            const newPassword = newPasswordInput.value;
            const confirmNewPassword = confirmNewPasswordInput.value;

            if (currentPassword !== state.profile.password) {
                alert(t('wrongPassword'));
                currentPasswordInput.focus();
                return;
            }

            if (newPassword.length < 4 || newPassword !== confirmNewPassword) {
                alert(t('passwordMismatch'));
                newPasswordInput.value = '';
                confirmNewPasswordInput.value = '';
                newPasswordInput.focus();
                return;
            }

            state.profile.password = newPassword;
            saveState();

            alert(t('saved'));
            currentPasswordInput.value = '';
            newPasswordInput.value = '';
            confirmNewPasswordInput.value = '';
        }

        window.selectChoice = function(element, key, value) { tempWizardState[key] = value; element.parentElement.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('selected')); element.classList.add('selected'); };
        
        function showWizardStep(step) {
            tempWizardState.currentStep = step;
            let content = `<div class="wizard-step-card">`;
            let backBtn = `<button class="btn btn-secondary" onclick="window.goWizardStep(${step - 1})">${t('back')}</button>`;
            let nextBtn = `<button class="btn btn-primary" onclick="window.goWizardStep(${step + 1})">${t('next')}</button>`;
            let stepHtml = '';
            
            const wizardType = tempWizardState.wizardType;
            let totalSteps = wizardType === 'full' ? 6 : (wizardType === 'reading' ? 1 : 1);
            if(wizardType === 'reading') totalSteps = 1;
            if(wizardType === 'revision') totalSteps = 1;


            switch (step) {
                case 1: 
                    if(wizardType !== 'full') {
                       if(wizardType === 'reading') showWizardStep(2);
                       else showWizardStep(3);
                       return;
                    }
                    stepHtml = `<h3>${t('step', {current: 1, total: totalSteps})} - ${t('profileInfo')}</h3>
                    <div class="form-group">
                      <label for="username">👤 ${t('nameKunya')}</label>
                      <input type="text" id="username" placeholder="${t('namePlaceholder')}" class="styled-input" value="${tempWizardState.name || ''}">
                    </div>
                    <div class="form-group">
                      <label>🎭 ${t('gender')}</label>
                      <div class="gender-options">
                        <label class="gender-choice">
                          <input type="radio" name="gender" value="male" ${tempWizardState.gender !== 'female' ? 'checked' : ''}>
                          <span>👳‍♂️ ${t('male')}</span>
                        </label>
                        <label class="gender-choice">
                          <input type="radio" name="gender" value="female" ${tempWizardState.gender === 'female' ? 'checked' : ''}>
                          <span>🧕 ${t('female')}</span>
                        </label>
                      </div>
                    </div>`;
                    backBtn = '';
                    break;
                case 2:
                    if(wizardType === 'revision') { showWizardStep(3); return; }
                    stepHtml = `<h3>${wizardType === 'full' ? t('step', {current: 2, total: totalSteps}) : t('readingGoals')}</h3>
                    <div class="form-group"><label for="duration">${t('duration')}</label><select id="duration" class="styled-input">${[3, 5, 7, 10, 15, 20, 30, 40, 60, 90, 120].map(d => `<option value="${d}" ${tempWizardState.duration == d ? 'selected':''}>${d}</option>`).join('')}</select></div>
                    <div class="form-group"><label for="khatmas">${t('khatmas')}</label><input type="number" id="khatmas" min="1" value="${tempWizardState.khatmas || 1}" class="styled-input"></div>
                    <div class="form-group"><label><input type="checkbox" id="kahf-option" onchange="window.toggleKahfPages(this)" ${tempWizardState.kahfOption ? 'checked':''}> ${t('kahfOption')}</label>
                        <div id="kahf-pages-container" class="hidden form-group" style="margin-top:10px;"><label for="kahf-pages">${t('kahfPages')}</label><input type="number" id="kahf-pages" min="0" max="20" value="${tempWizardState.kahfPages || 0}" class="styled-input"></div>
                    </div>`;
                    if(wizardType !== 'full') {
                        nextBtn = `<button class="btn btn-primary" onclick="window.finishWizard()">${t('finish')}</button>`;
                    }
                    setTimeout(() => {
                        const kahfCheckbox = document.getElementById('kahf-option');
                        if (kahfCheckbox) window.toggleKahfPages(kahfCheckbox);
                    }, 0);
                    break;
                case 3: 
                    if(wizardType === 'reading') { showWizardStep(4); return; }
                    stepHtml = `<h3>${wizardType === 'full' ? t('step', {current: 3, total: totalSteps}) : t('revisionSelection')}</h3>
                    <div class="form-group">
                      <label>${t('revisionMode')}</label>
                      <div class="revision-mode-selector">
                        <button class="btn btn-sm" id="rev-mode-btn-sourate" onclick="window.setWizardRevisionMode('sourate', this)">📜 ${t('revModeSurah')}</button>
                        <button class="btn btn-sm" id="rev-mode-btn-juzz" onclick="window.setWizardRevisionMode('juzz', this)">📦 ${t('revModeJuzz')}</button>
                        <button class="btn btn-sm" id="rev-mode-btn-hizb" onclick="window.setWizardRevisionMode('hizb', this)">🔖 ${t('revModeHizb')}</button>
                      </div>
                    </div>
                    <div id="revision-selection-area" class="grid-selection" style="max-height: 150px;"></div>
                    <div class="form-group"> <label for="unitsPerDay">${t('unitsPerDay')}</label> <input type="number" id="unitsPerDay" min="1" value="${tempWizardState.unitsPerDay || 1}" class="styled-input"> </div>
                    <div class="form-group"> <label for="revisionDuration">${t('revisionDuration')}</label> <input type="number" id="revisionDuration" min="1" max="365" value="${tempWizardState.revisionDuration || 30}" class="styled-input"> </div>
                    <div class="form-group"> <label>${t('revisionFrequency')}</label> <div class="choice-btn-group" style="grid-template-columns: repeat(3, 1fr);"> <div class="choice-btn" onclick="window.setRevisionFrequency('daily', this)">${t('freqDaily')}</div> <div class="choice-btn" onclick="window.setRevisionFrequency('weekly', this)">${t('freqWeekly')}</div> <div class="choice-btn" onclick="window.setRevisionFrequency('custom', this)">${t('freqCustom')}</div> </div> </div>
                    <div id="freq-options-container" class="hidden"></div>
                    <div class="form-group">
                        <label>${t('boosterSurah')}</label>
                        <div id="booster-surah-selection" class="grid-selection" style="max-height:150px;"></div>
                    </div>
                    <div id="booster-freq-container" class="form-group hidden">
                        <label for="boosterSurahFreq">${t('boosterSurahFreq')}</label>
                        <input type="number" id="boosterSurahFreq" min="1" value="1" class="styled-input">
                    </div>`;
                    if(wizardType !== 'full') {
                        nextBtn = `<button class="btn btn-primary" onclick="window.finishWizard()">${t('finish')}</button>`;
                    }
                    setTimeout(() => {
                        window.setWizardRevisionMode(tempWizardState.revisionMode || 'hizb');
                        window.setRevisionFrequency(tempWizardState.frequency.type || 'daily', wizardOverlay.querySelector('.choice-btn-group .choice-btn'));
                        renderWizardBoosterSurahOptions();
                    }, 0);
                    break;
                case 4: 
                    if(wizardType !== 'full') { showWizardStep(5); return; }
                    stepHtml = `<h3>${t('step', {current: 4, total: totalSteps})} - ${t('appearance')}</h3>
                    <div class="form-group"><label>${t('accentColor')}</label><div class="color-palette grid-selection">${COLORS.map(c => `<div class="color-swatch ${tempWizardState.accentColor === c ? 'selected':''}" style="background-color:${c};" data-color="${c}" onclick="window.selectColor(this)"></div>`).join('')}</div></div>
                    <div class="form-group"><label>${t('theme')}</label><div class="choice-btn-group" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">${THEMES.map(theme => `<div class="choice-btn ${tempWizardState.theme === theme.id ? 'selected':''}" data-value="${theme.id}" onclick="window.selectChoice(this, 'theme', '${theme.id}')"><span class="icon">${theme.icon}</span>${t(theme.id)}</div>`).join('')}</div></div>
                    <div class="form-group toggle-switch-container">
                        <label>${t('enableNotifications')}</label>
                        <label class="toggle-switch"> <input type="checkbox" id="enableNotifications" ${tempWizardState.enableNotifications ? 'checked' : ''}> <span class="slider"></span> </label>
                    </div>`;
                    break;
                case 5:
                    if(wizardType !== 'full') { showWizardStep(6); return; }
                    stepHtml = `<h3>${t('step', {current: 5, total: totalSteps})} - ${t('security')}</h3>
                    <div class="form-group"><label for="wizard-password">${t('createPassword')}</label><input type="password" id="wizard-password" class="styled-input" value="${tempWizardState.password || ''}"></div>
                    <div class="form-group"><label for="wizard-password-confirm">${t('confirmPassword')}</label><input type="password" id="wizard-password-confirm" class="styled-input"></div>`;
                    break;
                case 6: 
                    if(wizardType !== 'full') { finishWizard(); return; }
                    stepHtml = `<h3>${t('step', {current: 6, total: totalSteps})} - ${t('termsOfUse')}</h3>
                    <div class="terms-card-content">
                        <img src="https://i.postimg.cc/MvFHgV5v/logo.png" alt="Logo" id="terms-logo">
                        <p>${t('termsTextP1')}</p>
                        <p class="terms-warning">${t('termsTextP2')}</p>
                        <p>${t('termsTextP3')}</p>
                    </div>
                    <div class="form-group" style="margin-top: 20px; text-align:center;">
                        <label><input type="checkbox" id="terms-agree" onchange="document.getElementById('wizard-finish-btn').disabled = !this.checked;"> ${t('acceptTerms')}</label>
                    </div>`;
                    nextBtn = `<button id="wizard-finish-btn" class="btn btn-primary" onclick="window.finishWizard()" disabled>${t('finish')}</button>`;
                    break;
            }

            wizardOverlay.innerHTML = `<div class="modal-content"><div class="wizard-step-card">${content}${stepHtml}</div><div class="wizard-nav">${backBtn}${nextBtn}</div></div>`;
            const genderRadio = wizardOverlay.querySelector(`input[name="gender"][value="${tempWizardState.gender}"]`);
            if(genderRadio) genderRadio.checked = true;
            wizardOverlay.querySelectorAll(`.choice-btn[data-value="${tempWizardState.theme}"]`)?.forEach(b => b.classList.add('selected'));
        }
        
        function saveWizardStepData(step) {
            const el = (id) => wizardOverlay.querySelector(id);
            if (!el) return;

            switch(step) {
                case 1: 
                    if (el('#username')) tempWizardState.name = el('#username').value;
                    if (document.querySelector('input[name="gender"]:checked')) tempWizardState.gender = document.querySelector('input[name="gender"]:checked').value;
                    break;
                case 2: 
                    if (el('#duration')) tempWizardState.duration = parseInt(el('#duration').value); 
                    if (el('#khatmas')) tempWizardState.khatmas = parseInt(el('#khatmas').value);
                    if (el('#kahf-option')) tempWizardState.kahfOption = el('#kahf-option').checked; 
                    if (el('#kahf-pages')) tempWizardState.kahfPages = parseInt(el('#kahf-pages').value);
                    break;
                case 3:
                    if (el('#revisionDuration')) tempWizardState.revisionDuration = parseInt(el('#revisionDuration').value);
                    if (el('#unitsPerDay')) tempWizardState.unitsPerDay = parseInt(el('#unitsPerDay').value);
                    if (el('#boosterSurahFreq')) tempWizardState.boosterSurahFreq = parseInt(el('#boosterSurahFreq').value);
                    const freqType = tempWizardState.frequency.type;
                    if (freqType === 'weekly' && el('#freq-weekly-select')) {
                        tempWizardState.frequency.value = parseInt(el('#freq-weekly-select').value);
                    } else if (freqType === 'custom' && el('#freq-custom-input')) {
                        tempWizardState.frequency.value = parseInt(el('#freq-custom-input').value);
                    }
                    break;
                case 4:
                    if (el('#enableNotifications')) tempWizardState.enableNotifications = el('#enableNotifications').checked;
                    break;
                case 5:
                    if (el('#wizard-password')) tempWizardState.password = el('#wizard-password').value;
                    break;
            }
        }

        window.goWizardStep = function(nextStep) { 
            saveWizardStepData(tempWizardState.currentStep); 
            showWizardStep(nextStep); 
        };
        
        window.finishWizard = function() {
            saveWizardStepData(tempWizardState.currentStep);
            
            if (tempWizardState.wizardType === 'full') {
                if (tempWizardState.currentStep === 5 || tempWizardState.currentStep === 6) {
                    const password = tempWizardState.password;
                    const confirmPasswordInput = document.getElementById('wizard-password-confirm');
                    const confirmPassword = confirmPasswordInput ? confirmPasswordInput.value : password;

                    if (!password || password.length < 4 || password !== confirmPassword) {
                        alert(t('passwordMismatch'));
                        showWizardStep(5);
                        return;
                    }
                }
                
                if(tempWizardState.currentStep === 6) {
                    const termsCheckbox = document.getElementById('terms-agree');
                    if (!termsCheckbox || !termsCheckbox.checked) {
                        alert(t('pleaseAcceptTerms'));
                        return;
                    }

                    state.profile = { 
                        password: tempWizardState.password,
                        name: tempWizardState.name,
                        gender: tempWizardState.gender,
                        memorizations: { surahs: [], hizbs: [], juzz: [] }
                    };
                    state.settings = { ...defaultState.settings, lang: state.settings.lang, theme: tempWizardState.theme, accentColor: tempWizardState.accentColor, enableNotifications: tempWizardState.enableNotifications };
                    
                    let newStartDate = new Date();
                    if (tempWizardState.wizardMode === 'resume' && tempWizardState.currentDay > 1) {
                        newStartDate.setDate(newStartDate.getDate() - (tempWizardState.currentDay - 1));
                    }
                    state.progress = { ...defaultState.progress, startDate: getTodayDateString(newStartDate), history: { reading: [], revision: [], toReview: [] } };
                    
                    if (tempWizardState.wizardMode === 'resume') {
                        state.progress.currentReadingDay = tempWizardState.currentDay || 1;
                    }
                }
            }
            
            if (!state.profile.goals) state.profile.goals = {};

            if (tempWizardState.wizardType === 'reading' || tempWizardState.wizardType === 'full') {
                 state.profile.goals.reading = { duration: tempWizardState.duration, khatmas: tempWizardState.khatmas, kahfOption: tempWizardState.kahfOption, kahfPages: tempWizardState.kahfPages };
                 generateReadingPlan();
                 recalculateFuturePlan();
            }
             if (tempWizardState.wizardType === 'revision' || tempWizardState.wizardType === 'full') {
                state.profile.goals.revision = { 
                    selection: tempWizardState.selection, 
                    revisionMode: tempWizardState.revisionMode, 
                    unitsPerDay: tempWizardState.unitsPerDay,
                    revisionDuration: tempWizardState.revisionDuration,
                    frequency: tempWizardState.frequency,
                    boosterSurahs: tempWizardState.boosterSurahs,
                    boosterSurahFreq: tempWizardState.boosterSurahFreq
                };
                generateRevisionPlan();
            }
            
            saveState();
            wizardOverlay.classList.add('hidden'); 
            initAppUI();
        };

        function initAppUI() {
            applyThemeAndLang(); 
            translateStaticUI();
            
            if(state.profile) {
                document.getElementById('app-title').textContent = t('appName');
                document.getElementById('header-greeting').innerHTML = `${t('greeting')}<br>${state.profile.name}`;
                document.getElementById('profile-initial').textContent = state.profile.name.charAt(0).toUpperCase();
                document.getElementById('profile-section').classList.remove('hidden');
                document.getElementById('toggle-theme-btn').textContent = `🌓 ${t('toggleTheme')}`;
                document.getElementById('logout-btn').textContent = `🔒 ${t('logout')}`;
                document.getElementById('reset-btn').textContent = `🗑 ${t('resetApp')}`;
            }
            
            mainNav.innerHTML = `<button class="nav-tab active" data-view="dashboard-view" onclick="window.switchView('dashboard-view')">📊 ${t('dashboard')}</button>
                <button class="nav-tab" data-view="reading-plan-view" onclick="window.switchView('reading-plan-view')">📅 ${t('readingPlan')}</button>
                <button class="nav-tab" data-view="revision-plan-view" onclick="window.switchView('revision-plan-view')">🧠 ${t('revisionPlan')}</button>
                <button class="nav-tab" data-view="memorization-view" onclick="window.switchView('memorization-view')">💖 ${t('memorization')}</button>
                <button class="nav-tab" data-view="history-view" onclick="window.switchView('history-view')">📂 ${t('history')}</button>
                <button class="nav-tab" data-view="settings-view" onclick="window.switchView('settings-view')">⚙️ ${t('settings')}</button>`;
            
            welcomeScreen.classList.add('hidden');
            initialChoiceScreen.classList.add('hidden');
            loginScreen.classList.add('hidden');
            wizardOverlay.classList.add('hidden');
            appContainer.classList.remove('hidden');
            whatsappShareFloatBtn.classList.remove('hidden');
            switchView('dashboard-view');
        }
        
        window.startWizard = function(mode, type) {
            initialChoiceScreen.classList.add('hidden');
            
            const currentProfile = state.profile || {};
            const currentSettings = state.settings || defaultState.settings;

            tempWizardState = { 
                wizardMode: mode, 
                wizardType: type,
                currentStep: 1, 
                lang: currentSettings.lang, 
                gender: currentProfile.gender || 'male', 
                name: currentProfile.name || '',
                password: '',
                accentColor: currentSettings.accentColor || '#2E7D32', 
                theme: currentSettings.theme || 'light', 
                enableNotifications: currentSettings.enableNotifications !== false,
                duration: 30, khatmas: 1, kahfOption: false, kahfPages: 0, 
                revisionMode: 'hizb',
                unitsPerDay: 1,
                revisionDuration: 30,
                frequency: { type: 'daily', value: 1 },
                boosterSurahs: [],
                boosterSurahFreq: 1,
                selection: []
            };
            
            if (mode === 'resume') {
                wizardOverlay.innerHTML = `<div class="modal-content">
                    <h3>${t('resumeProgram')}</h3>
                    <div class="form-group">
                        <label for="resume-day">${t('resumeDayPrompt')}</label>
                        <input type="number" id="resume-day" value="1" min="1" class="styled-input">
                    </div>
                    <button class="btn btn-primary" onclick="window.confirmResumeProgram()">${t('continue')}</button>
                </div>`;
                wizardOverlay.classList.remove('hidden');
                return;
            }

            wizardOverlay.classList.remove('hidden');
            showWizardStep(1);
        };
        
        window.confirmResumeProgram = function() {
            const day = parseInt(document.getElementById('resume-day').value);
            tempWizardState.currentDay = isNaN(day) ? 1 : day;
            showWizardStep(1); 
        };

        window.showLoginScreen = function() {
            welcomeScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            applyThemeAndLang();
            document.getElementById('login-welcome-title').textContent = t('welcomeGreeting');
            document.getElementById('login-prompt-title').textContent = t('enterPassword');
            document.getElementById('login-button').textContent = t('login');
            document.getElementById('forgot-password-link').textContent = t('forgotPassword');
            document.getElementById('password-input').focus();
        };

        window.showInitialChoiceScreen = function() {
            welcomeScreen.classList.add('hidden');
            initialChoiceScreen.classList.remove('hidden');
            applyThemeAndLang();
            document.getElementById('program-type-title').textContent = t('programType');
            document.getElementById('start-new-text').textContent = t('startNew');
            document.getElementById('start-new-desc').textContent = t('startNewDesc');
            document.getElementById('resume-program-text').textContent = t('resumeProgram');
            document.getElementById('resume-program-desc').textContent = t('resumeProgramDesc');
        };

        function setupLoginHandler() {
            const passwordInput = document.getElementById('password-input');
            const loginButton = document.getElementById('login-button');
            const passwordError = document.getElementById('password-error');
            const attemptLogin = () => {
                if (state.profile && passwordInput.value === state.profile.password) { initAppUI(); } 
                else { passwordError.textContent = t('wrongPassword'); passwordError.classList.remove('hidden'); passwordInput.value = ''; passwordInput.focus(); }
            };
            loginButton.addEventListener('click', attemptLogin);
            passwordInput.addEventListener('keyup', (e) => e.key === 'Enter' && attemptLogin());
            document.getElementById('forgot-password-link').addEventListener('click', () => window.handleResetApp());
            document.getElementById('back-to-welcome-btn').addEventListener('click', () => {
                 loginScreen.classList.add('hidden');
                 showWelcomeScreen();
            });
        }

        window.setStartLanguage = function(lang) {
            localStorage.setItem("language", lang);
            state.settings.lang = lang;
            saveState();
            languageScreen.style.display = "none";
            startApplicationFlow();
        }

        function showWelcomeScreen() {
             applyThemeAndLang();
             translateStaticUI();
             document.getElementById('create-profile-btn').textContent = t('createProfile');
             document.getElementById('login-btn').textContent = t('login');
             welcomeScreen.style.display = "flex";
        }
        
        function renderMemorization() {
            const view = document.getElementById('memorization-view');
            const memorizations = state.profile.memorizations;
            const levels = { excellent: t('excellent'), bon: t('bon'), moyen: t('moyen') };

            let surahsHTML = `<h4>${t('memorizedSurahs')}</h4>`;
            if (!memorizations.surahs || memorizations.surahs.length === 0) {
                surahsHTML += `<p>${t('noMemorizedSurahs')}</p>`;
            } else {
                memorizations.surahs.forEach(s => {
                    surahsHTML += `<div class="memorized-list-item"><span>${s.id}. ${s.name} (${s.verses} versets)</span> <span class="memorized-level-badge level-${s.level}">${levels[s.level]}</span></div>`;
                });
            }

            let hizbsHTML = `<h4>${t('memorizedHizbs')}</h4>`;
            if (!memorizations.hizbs || memorizations.hizbs.length === 0) {
                hizbsHTML += `<p>${t('noMemorizedHizbs')}</p>`;
            } else {
                memorizations.hizbs.forEach(h => {
                    hizbsHTML += `<div class="memorized-list-item"><span>${t('hizb')} ${h.number} <small>(${h.details})</small></span> <span class="memorized-level-badge level-${h.level}">${levels[h.level]}</span></div>`;
                });
            }

             let juzzHTML = `<h4>${t('memorizedJuzz')}</h4>`;
            if (!memorizations.juzz || memorizations.juzz.length === 0) {
                juzzHTML += `<p>${t('noMemorizedJuzz')}</p>`;
            } else {
                memorizations.juzz.forEach(j => {
                    juzzHTML += `<div class="memorized-list-item"><span>${t('juzz')} ${j.number}</span> <span class="memorized-level-badge level-${j.level}">${levels[j.level]}</span></div>`;
                });
            }

            const formHTML = `<div class="add-memorization-form">
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="window.showAddMemorizationForm('surah')">➕ ${t('addMemorizedSurah')}</button>
                    <button class="btn btn-secondary" onclick="window.showAddMemorizationForm('hizb')">➕ ${t('addMemorizedHizb')}</button>
                    <button class="btn btn-secondary" onclick="window.showAddMemorizationForm('juzz')">➕ ${t('addMemorizedJuzz')}</button>
                </div>
                <div id="add-memorization-container" class="hidden" style="margin-top: 20px;"></div>
            </div>`;
            
            view.innerHTML = `<div class="card">
                <div class="card-header"><span class="icon">💖</span><h3>${t('memorizedTitle')}</h3></div>
                ${surahsHTML}<hr style="margin: 20px 0;">${hizbsHTML}<hr style="margin: 20px 0;">${juzzHTML}
                ${formHTML}
            </div>`;
        }
        
        window.showAddMemorizationForm = function(type) {
            const container = document.getElementById('add-memorization-container');
            container.classList.remove('hidden');
            let optionsHTML = '';
            
            if (type === 'surah') {
                optionsHTML = FULL_SURAH_LIST.map(s => `<option value="${s.id}">${s.id}. ${s.name}</option>`).join('');
            } else if (type === 'hizb') {
                optionsHTML = HIZB_DATA.map((h,i) => `<option value="${i}">${t('hizb')} ${h.name}</option>`).join('');
            } else {
                optionsHTML = JUZ_DATA.map(j => `<option value="${j.id}">${t('juzz')} ${j.id}</option>`).join('');
            }
            
            container.innerHTML = `<div class="form-group">
                <label for="memorized-select">${t(type)}:</label>
                <select id="memorized-select" class="styled-input">${optionsHTML}</select>
            </div>
            <div class="form-group">
                <label for="memorized-level-select">${t('level')}:</label>
                <select id="memorized-level-select" class="styled-input">
                    <option value="excellent">${t('excellent')}</option>
                    <option value="bon">${t('bon')}</option>
                    <option value="moyen">${t('moyen')}</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="window.addMemorization('${type}')">${t('add')}</button>`;
        }
        
        window.addMemorization = function(type) {
            const selectEl = document.getElementById('memorized-select');
            const levelEl = document.getElementById('memorized-level-select');
            const id = parseInt(selectEl.value);
            const level = levelEl.value;

            if (type === 'surah') {
                const surahData = FULL_SURAH_LIST.find(s => s.id === id);
                if (surahData && !state.profile.memorizations.surahs.find(s => s.id === id)) {
                    state.profile.memorizations.surahs.push({ ...surahData, level });
                }
            } else if (type === 'hizb') {
                const hizbData = HIZB_DATA[id];
                if (hizbData && !state.profile.memorizations.hizbs.find(h => h.number === hizbData.name)) {
                    state.profile.memorizations.hizbs.push({ number: hizbData.name, details: hizbData.details, level });
                }
            } else { 
                if (!state.profile.memorizations.juzz.find(j => j.number === id)) {
                    state.profile.memorizations.juzz.push({ number: id, level });
                }
            }
            saveState();
            renderMemorization();
        }

        window.setWizardRevisionMode = function(mode, element) {
            tempWizardState.revisionMode = mode;
            tempWizardState.selection = [];
            
            document.querySelectorAll('.revision-mode-selector .btn').forEach(btn => btn.classList.remove('active'));
            if(element) element.classList.add('active');
            else document.getElementById(`rev-mode-btn-${mode}`).classList.add('active');

            renderWizardRevisionOptions();
        }
        window.toggleWizardSelection = function(element, id, type) {
            const list = tempWizardState[type];
            const idAsString = id.toString();
            const index = list.indexOf(idAsString);
            if (index > -1) {
                list.splice(index, 1);
                element.classList.remove('selected');
            } else {
                list.push(idAsString);
                element.classList.add('selected');
            }
            if (type === 'boosterSurahs') {
                document.getElementById('booster-freq-container').classList.toggle('hidden', list.length === 0);
            }
        }
        window.toggleKahfPages = function (checkbox) {
            const container = document.getElementById('kahf-pages-container');
            if(container) container.classList.toggle('hidden', !checkbox.checked);
        };
        window.setRevisionFrequency = function(type, element) {
            tempWizardState.frequency.type = type;
            const container = document.getElementById('freq-options-container');

            if (element) {
                element.parentElement.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('selected'));
                element.classList.add('selected');
            }
            
            let html = '';
            if (type === 'weekly') {
                const days = t('dayOfWeek');
                html = `<div class="form-group"><label>${t('onDay')}</label><select id="freq-weekly-select" class="styled-input">${days.map((d, i) => `<option value="${i}">${d}</option>`).join('')}</select></div>`;
            } else if (type === 'custom') {
                html = `<div class="form-group"><label>${t('everyXDays', {count: ''}).replace('{count}', '')}</label><input type="number" id="freq-custom-input" min="2" value="2" class="styled-input"></div>`;
            }
            
            container.innerHTML = html;
            container.classList.toggle('hidden', type === 'daily');
        }
        
        function renderWizardRevisionOptions() {
            const container = document.getElementById("revision-selection-area");
            if (!container) return;
            let html = '';
            const mode = tempWizardState.revisionMode;

            if (mode === 'sourate') {
                html = FULL_SURAH_LIST.map(s => `
                    <div class="grid-item ${tempWizardState.selection.includes(s.id.toString()) ? 'selected' : ''}" onclick="toggleWizardSelection(this, '${s.id}', 'selection')">
                        ${s.id}. ${s.name}
                    </div>`).join('');
            } else if (mode === 'juzz') {
                html = JUZ_DATA.map(j => `
                    <div class="grid-item ${tempWizardState.selection.includes(j.id.toString()) ? 'selected' : ''}" onclick="toggleWizardSelection(this, '${j.id}', 'selection')">
                        ${t('juzz')} ${j.id}
                    </div>`).join('');
            } else { 
                html = HIZB_DATA.map((h, i) => `
                    <div class="grid-item ${tempWizardState.selection.includes(i.toString()) ? 'selected' : ''}" onclick="toggleWizardSelection(this, '${i}', 'selection')">
                        ${t('hizb')} ${h.name}<br><small>${h.details}</small>
                    </div>`).join('');
            }
            container.innerHTML = html;
        }

        function renderWizardBoosterSurahOptions() {
            const container = document.getElementById("booster-surah-selection");
            if (!container) return;
            container.innerHTML = FULL_SURAH_LIST.map(s => `
                <div class="grid-item ${tempWizardState.boosterSurahs.includes(s.id.toString()) ? 'selected' : ''}" onclick="toggleWizardSelection(this, '${s.id}', 'boosterSurahs')">
                    ${s.id}. ${s.name}
                </div>`).join('');
        }

        window.toggleProfileMenu = function() {
            const dropdown = document.getElementById("profile-dropdown");
            dropdown.classList.toggle("hidden");
        }
        window.selectColor = function(element) { 
            tempWizardState.accentColor = element.dataset.color; 
            document.querySelectorAll('.color-palette .color-swatch').forEach(sw => sw.classList.remove('selected')); 
            element.classList.add('selected'); 
        };
        window.toggleQuickTheme = function() {
            const currentTheme = state.settings.theme;
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            window.updateTheme(newTheme);
        }

        function startApplicationFlow() {
            splashScreen.style.display = "flex";
            setTimeout(() => {
                splashScreen.style.display = "none";
                if (state.profile && state.profile.password) {
                    showLoginScreen();
                    setupLoginHandler();
                } else {
                    showWelcomeScreen();
                }
            }, 4000);
        }

        // ##### INITIALIZATION LOGIC #####
        loadState();
        applyThemeAndLang();
        translateStaticUI();

        const savedLang = localStorage.getItem("language");

        if (!savedLang) {
            languageScreen.style.display = "flex";
        } else {
            startApplicationFlow();
        }
        
        document.getElementById('create-profile-btn').addEventListener('click', showInitialChoiceScreen);
        
        document.getElementById('login-btn').addEventListener('click', () => {
            if (state.profile) { 
                showLoginScreen();
                setupLoginHandler();
            } else {
                showInitialChoiceScreen(); 
            }
        });
        
        // ### ÉTAPE 3.2 : Enregistrer le Service Worker ###
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker enregistré avec succès :', registration.scope);
                    })
                    .catch(error => {
                        console.log('Échec de l\'enregistrement du ServiceWorker :', error);
                    });
            });
        }

    });
    </script>
</body>
</html>
